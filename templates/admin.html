<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="vapid-public" content="{{ vapid_public }}">
<script>window.VAPID_PUBLIC = "{{ vapid_public }}";</script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <title>Administraci√≥n</title>

  <!-- Estilos admin -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

  <!-- Iconos -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Header compacto -->
  <header class="admin-header">
<a href="{{ url_for('html.serve_index') }}" class="admin-back">      <i class="fas fa-arrow-left"></i><span>Volver</span>
    </a>
    <h1>Administraci√≥n</h1>
  </header>

  <main class="admin-container">
    <!-- ===== Secci√≥n: Alimentaci√≥n / Gesti√≥n r√°pida ===== -->
    <section class="admin-section" id="admin-alimentacion-formularios">
      <h2>Gesti√≥n r√°pida</h2>
      <div class="admin-card">

        <!-- Botones para alternar -->
        <div class="activity-type-buttons" style="justify-content:center; gap:12px;">
          <button class="icon-button" data-type="Ingrediente" id="btn-ingrediente-actividad" type="button">
            <i class="fas fa-carrot"></i><span>Ingrediente</span>
          </button>
          <button class="icon-button" data-type="Receta" id="btn-receta-actividad" type="button">
            <i class="fas fa-utensils"></i><span>Receta</span>
          </button>
          <!-- NUEVO: M√∫sica -->
          <button class="icon-button" data-type="Musica" id="btn-musica-actividad" type="button">
            <i class="fas fa-music" style="color:#ff4d4d"></i><span>M√∫sica</span>
          </button>
        </div>

        <div class="section-content" id="form-nueva-actividad">
          <form id="nueva-actividad-formulario">
            <!-- Nombre / descripci√≥n -->
            <div id="grupo-nombre-descripcion" class="oculto">
              <div class="form-group">
                <label for="nueva-actividad-descripcion">Nombre / descripci√≥n</label>
                <input id="nueva-actividad-descripcion" type="text" placeholder="Escribe el nombre..." autocomplete="off" />
              </div>
            </div>

            <div id="formularios-actividad" class="oculto">
              <!-- Form INGREDIENTE -->
              <div class="tipo-formulario oculto" id="form-ingrediente">
                <div class="form-grid-3cols">
                  <div class="form-group">
                    <label for="ingrediente-supermercado">Supermercado:</label>
                    <select id="ingrediente-supermercado">
                      <option value="Lidl">Lidl</option>
                      <option value="Mercadona">Mercadona</option>
                      <option value="Carrefour">Carrefour</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-precio">Precio:</label>
                    <input id="ingrediente-precio" type="number" step="0.01" />
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-cantidad">Cantidad:</label>
                    <input id="ingrediente-cantidad" type="number" step="0.01" />
                  </div>
                </div>

                <div class="form-grid-3cols">
                  <div class="form-group">
                    <label for="ingrediente-unidad">Unidad:</label>
                    <select id="ingrediente-unidad">
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="unidad">unidad</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-calorias">Calor√≠as:</label>
                    <input id="ingrediente-calorias" type="number" />
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-proteinas">Prote√≠nas:</label>
                    <input id="ingrediente-proteinas" type="number" step="0.1" />
                  </div>
                </div>
              </div>

              <!-- Form RECETA -->
              <div class="tipo-formulario oculto" id="form-receta">
                <div class="form-group">
                  <label for="receta-instrucciones">Instrucciones:</label>
                  <textarea id="receta-instrucciones" name="receta_instrucciones" placeholder="Pasos para preparar la receta..." rows="5"></textarea>
                </div>

                <div class="form-group">
                  <label>Ingredientes de la Receta:</label>
                  <div class="requirements-list" id="receta-ingredientes-container"></div>
                  <div class="add-requirement-input">
                    <select class="select-full-width" id="receta-seleccionar-ingrediente">
                      <option value="">Selecciona un ingrediente</option>
                    </select>
                    <input id="receta-cantidad-ingrediente" placeholder="Cantidad" step="0.01" type="number"/>
                    <select id="receta-unidad-ingrediente">
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="unidad">unidad</option>
                    </select>
                    <button class="btn-secondary" id="btn-a√±adir-ingrediente-receta" type="button">A√±adir Ingrediente</button>
                  </div>
                </div>

                <div id="totales-receta" style="margin-top: 10px;">
                  <p><strong>Precio total:</strong> <span id="total-precio">0.00</span> ‚Ç¨</p>
                  <p><strong>Calor√≠as totales:</strong> <span id="total-calorias">0</span> kcal</p>
                  <p><strong>Prote√≠nas totales:</strong> <span id="total-proteinas">0</span> g</p>
                </div>
              </div>

              <!-- NUEVO: Form M√öSICA -->
              <div class="tipo-formulario oculto" id="form-musica">
                <div class="form-group">
                  <label>Subir canciones</label>
                  <input id="musica-archivo-multiple" type="file" accept="audio/*" multiple />
                  <div class="form-text">Formato recomendado: <em>Artista - T√≠tulo.mp3</em></div>
                </div>

                <div class="form-group">
                  <label>T√≠tulo (opcional si subes solo 1)</label>
                  <input id="musica-titulo-opcional" type="text" placeholder="Si subes una sola, puedes forzar aqu√≠ el t√≠tulo" />
                </div>

                <div class="form-buttons">
                  <button class="btn-success" id="btn-subir-musica" type="button">Subir m√∫sica</button>
                  <button class="btn-cancel" id="btn-cancelar-musica" type="button">Cancelar</button>
                </div>

                <div id="musica-resultado" class="form-text" style="margin-top:8px;"></div>
              </div>
              <!-- FIN Form M√öSICA -->
            </div>

            <!-- Botonera general (no se usa en m√∫sica) -->
            <div class="form-buttons oculto" id="botones-actividad">
              <button class="btn-success btn-large" id="btn-guardar-actividad" type="submit">Guardar</button>
              <button class="btn-cancel" id="cancelar-nueva-actividad" type="button">Cancelar</button>
            </div>
          </form>
        </div>

      </div>
    </section>

    <!-- ===== Secci√≥n: Accesos de alimentaci√≥n ===== -->
    <section class="admin-section" id="admin-alimentacion-accesos">
      <h2>Accesos de alimentaci√≥n</h2>
      <div class="admin-card">
        <div class="admin-actions">
          <a class="admin-btn" href="/menu">
            <i class="fas fa-calendar-week"></i><span>Men√∫</span>
          </a>
          <a class="admin-btn" href="/despensa">
            <i class="fas fa-basket-shopping"></i><span>Despensa</span>
          </a>
          <a class="admin-btn" href="/alimentacion">
            <i class="fas fa-apple-whole"></i><span>Alimentaci√≥n</span>
          </a>
        </div>
      </div>
    </section>

    <!-- ===== Secci√≥n: Productividad / Mejoras ===== -->
    <section class="admin-section" id="admin-mejoras-accesos">
      <h2>Accesos productividad</h2>
      <div class="admin-card">
        <div class="admin-actions">
<a class="admin-btn" href="{{ url_for('html.mejoras') }}">            <i class="fas fa-wrench"></i><span>Mejoras</span>
          </a>
        </div>
      </div>
    </section>
    <!-- ===== Secci√≥n: Notificaciones ===== -->


    </div>
    <div id="os-status" class="form-text" style="margin-top:8px;">Estado: ‚Äî</div>
  </div>
</section>

<section class="main-section" id="familia">
  <h2>Grupo familiar</h2>

  <div class="section-content">
    <div class="form-grid-2cols">
      <div class="form-group">
        <label>Nombre del grupo</label>
        <input id="grp-nombre" type="text" placeholder="Ej: Familia Ra√∫l">
      </div>
      <div class="form-group">
        <label>&nbsp;</label>
        <button id="grp-crear" class="btn-success">Crear grupo</button>
      </div>
    </div>

    <hr style="opacity:.2;margin:12px 0;">

    <div id="mis-grupos"></div>

    <div id="panel-miembros" class="oculto" style="margin-top:12px;">
      <h3>Miembros del grupo: <span id="nombre-grupo-actual"></span></h3>

      <div class="form-grid-3cols">
        <div class="form-group">
          <label>Usuario (username)</label>
          <input id="mbr-username" type="text" placeholder="p.ej. derek">
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select id="mbr-rol">
            <option value="miembro">Miembro</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button id="mbr-agregar" class="btn-secondary">A√±adir miembro</button>
        </div>
      </div>

      <ul id="lista-miembros"></ul>
    </div>
  </div>
</section>
<!-- ========== NOTIFICACIONES ========== -->
<section class="admin-card" style="margin-top:1rem">
  <h2>üîî Notificaciones</h2>

  <div style="display:flex;gap:12px;flex-wrap:wrap;margin:.5rem 0">
    <button id="btn-notify-sub" class="admin-btn">Suscribirme</button>
    <button id="btn-notify-unsub" class="admin-btn">Desuscribirme</button>
    <button id="btn-notify-test" class="admin-btn">Probar env√≠o</button>
    <span id="notify-status" style="align-self:center">Estado: ‚Äî</span>
  </div>

  <hr style="opacity:.2">

  <h3 style="margin:.5rem 0">‚è±Ô∏è Horarios por defecto</h3>
  <form id="notify-prefs" style="display:grid;grid-template-columns:180px 1fr;gap:10px;max-width:640px">

  <!-- Rutinas -->
  <h4 style="grid-column:1/-1;margin:.5rem 0 0">Rutinas</h4>
  <label for="rut_mins">Avisar minutos antes</label>
  <input id="rut_mins" type="number" min="0" step="1" value="15">

  <!-- Tareas -->
  <h4 style="grid-column:1/-1;margin:.5rem 0 0">Tareas</h4>
  <label for="tas_mins">Avisar minutos antes</label>
  <input id="tas_mins" type="number" min="0" step="1" value="15">

  <!-- Citas -->
  <h4 style="grid-column:1/-1;margin:.5rem 0 0">Citas</h4>
  <div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:10px">
    <label><input type="checkbox" class="apt_preset" data-min="-43200"> 1 mes</label>
    <label><input type="checkbox" class="apt_preset" data-min="-21600"> 15 d√≠as</label>
    <label><input type="checkbox" class="apt_preset" data-min="-1440"> 1 d√≠a</label>
    <label><input type="checkbox" class="apt_preset" data-min="-60"> 1 hora</label>
  </div>

  <label for="apt_custom_val">Personalizada</label>
  <div>
    <input id="apt_custom_val" type="number" min="1" step="1" value="30" style="width:120px">
    <select id="apt_custom_unit">
      <option value="min">min</option>
      <option value="h">horas</option>
      <option value="d">d√≠as</option>
    </select>
    <button type="button" id="apt_add" class="admin-btn" style="margin-left:8px">A√±adir alarma</button>
    <small style="margin-left:8px;opacity:.7">(m√°x. 3 en total)</small>
  </div>

  <div style="grid-column:1/-1">
    <div id="apt_list" style="display:flex;gap:8px;flex-wrap:wrap"></div>
  </div>

  <div></div>
  <button class="admin-btn" type="submit">Guardar</button>
</form>


</section>

<script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    navigator.serviceWorker
      .register('/sw.js?v=20250824', { scope: '/' }) // üëà a√±adimos versi√≥n
      .then(reg => {
        console.log('[admin] SW registrado:', reg.scope);
        // Si hay un SW nuevo, que tome control ya
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      })
      .catch(err => console.error('[admin] Error registrando SW:', err));
  })();
</script>



<script type="module">
  const username = localStorage.getItem('usuario_actual') || 'raul@gmail.com';

  async function loadPrefs() {
    try {
      const r = await fetch(`/api/notification-prefs?username=${encodeURIComponent(username)}`);
      const data = await r.json();
      if (!r.ok || !data.ok) return console.warn("No se pudieron cargar prefs", data);

      const prefs = data.prefs || {};
      const rut = prefs.routines?.offsets?.[0] ?? -15;
      const tas = prefs.tasks?.offsets?.[0] ?? -15;
      const apt = prefs.appointments?.offsets ?? [];

      // rutinas/tareas ‚Üí absolutos
      document.getElementById("rut_mins").value = Math.abs(rut);
      document.getElementById("tas_mins").value = Math.abs(tas);

      // citas ‚Üí chips
      const list = document.getElementById("apt_list");
      list.innerHTML = "";
      apt.slice(0, 3).forEach(v => {
        const chip = document.createElement("span");
        chip.dataset.min = String(v);
        chip.textContent = `${Math.abs(v)} min antes `;
        const x = document.createElement("button");
        x.type = "button";
        x.textContent = "√ó";
        x.onclick = () => chip.remove();
        chip.appendChild(x);
        list.appendChild(chip);
      });
    } catch (e) {
      console.error("Error cargando prefs", e);
    }
  }

  loadPrefs();
</script>





<script type="module">
  // ===== PUSH (solo suscripci√≥n / prueba) =====
  const $ = (s) => document.querySelector(s);
  const statusEl = $('#notify-status');
  const username = localStorage.getItem('usuario_actual') || 'raul@gmail.com';
  const VAPID_PUBLIC = "{{ vapid_public }}";   // inyectado por Flask

  const toUint8 = (b64u) => {
    const pad = '='.repeat((4 - (b64u.length % 4)) % 4);
    const s = (b64u + pad).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(s);
    const arr = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
    return arr;
  };

  async function pushStatus() {
    try {
      if (!('serviceWorker' in navigator)) {
        statusEl.textContent = 'Estado: SW no disponible';
        return;
      }
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      const perm = Notification.permission;
      statusEl.textContent = sub
        ? `Estado: ‚úÖ suscrito (${perm})`
        : `Estado: ‚ö†Ô∏è no suscrito (${perm})`;
    } catch (e) {
      statusEl.textContent = 'Estado: error';
      console.error(e);
    }
  }

  async function subscribe() {
    try {
      if (Notification.permission !== 'granted') {
        const p = await Notification.requestPermission();
        if (p !== 'granted') { statusEl.textContent = 'Permiso denegado'; return; }
      }
      const reg = await navigator.serviceWorker.ready;

      // opcional: limpia suscripci√≥n vieja
      const old = await reg.pushManager.getSubscription();
      if (old) await old.unsubscribe();

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: toUint8(VAPID_PUBLIC),
      });

      const s = sub.toJSON();
      const resp = await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          username, endpoint: s.endpoint, p256dh: s.keys.p256dh, auth: s.keys.auth
        })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) throw new Error(JSON.stringify(data));
      statusEl.textContent = 'Estado: ‚úÖ suscrito';
    } catch (e) {
      console.error('subscribe error', e);
      statusEl.textContent = 'Estado: error al suscribir';
    }
  }

  async function unsubscribe() {
    try {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      if (sub) {
        const endpoint = sub.endpoint;
        await sub.unsubscribe();
        await fetch('/api/push/unsubscribe', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, endpoint })
        });
      }
      statusEl.textContent = 'Estado: ‚ö†Ô∏è no suscrito';
    } catch (e) {
      console.error('unsubscribe error', e);
      statusEl.textContent = 'Estado: error al desuscribir';
    }
  }

  async function sendTest() {
    try {
      const resp = await fetch('/api/push/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, title: 'üîî Prueba', body: 'Notificaci√≥n de prueba', url: '/' })
      });
      const ct = resp.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await resp.json() : await resp.text();
      console.log('push/send ->', resp.status, data);
      if (!resp.ok) alert('Fall√≥ el env√≠o: ' + (data.error || resp.status));
    } catch (e) {
      console.error(e);
      alert('Error al enviar');
    }
  }

  // Botones push
  $('#btn-notify-sub')?.addEventListener('click', subscribe);
  $('#btn-notify-unsub')?.addEventListener('click', unsubscribe);
  $('#btn-notify-test')?.addEventListener('click', sendTest);

  pushStatus();
</script>

<!-- ========== /NOTIFICACIONES ========== -->
<script type="module">
  const DEFAULT_APT = [-43200, -21600, -1440, -60];
  const username = localStorage.getItem('usuario_actual') || 'raul@gmail.com';

  const $ = (s) => document.querySelector(s);

  function currentAptOffsets() {
    const list = document.getElementById('apt_list');
    if (!list) return [];
    return [...list.querySelectorAll('span[data-min]')].map(s => parseInt(s.dataset.min, 10));
  }

  // Guardado robusto
document.getElementById('notify-prefs')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const rutEl = document.getElementById('rut_mins');
  const tasEl = document.getElementById('tas_mins');

  const rut = parseInt(rutEl?.value ?? '15', 10);
  const tas = parseInt(tasEl?.value ?? '15', 10);

  // aseg√∫rate de que sean negativos (‚Äúminutos antes‚Äù)
  const rutOff = -Math.abs(isFinite(rut) ? rut : 15);
  const tasOff = -Math.abs(isFinite(tas) ? tas : 15);

  let apt = currentAptOffsets();
  if (!apt.length) apt = DEFAULT_APT;
  apt = apt.slice(0, 3).map(n => (n <= 0 ? n : -Math.abs(n)));

  // üëá Aqu√≠ a√±adimos el log para ver qu√© se manda
console.log("Payload enviado ‚Üí", JSON.stringify({
  username,
  routines:     { offsets: [rutOff] },
  tasks:        { offsets: [tasOff] },
  appointments: { offsets: apt }
}, null, 2));


  try {
    const r = await fetch('/api/notification-prefs', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        username,
        routines:     { offsets: [rutOff] },
        tasks:        { offsets: [tasOff] },
        appointments: { offsets: apt }
      })
    });
    const data = await r.json().catch(() => ({}));
    if (r.ok && data.ok) {
      console.log('Preferencias guardadas');
    } else {
      console.warn('Guardar fall√≥', r.status, data);
      alert('No se pudo guardar preferencias.');
    }
  } catch (err) {
    console.error('savePrefs error', err);
    alert('Error de red guardando preferencias.');
  }
});


  // (opcional) A√±adir alarma personalizada
  document.getElementById('apt_add')?.addEventListener('click', () => {
    const valEl = document.getElementById('apt_custom_val');
    const unitEl = document.getElementById('apt_custom_unit');
    const list   = document.getElementById('apt_list');
    if (!valEl || !unitEl || !list) return;

    let v = parseInt(valEl.value, 10);
    if (!isFinite(v) || v <= 0) return;

    const u = unitEl.value;
    if (u === 'h') v *= 60;
    if (u === 'd') v *= 1440;
    v = -Math.abs(v);

    const curr = currentAptOffsets();
    if (curr.length >= 3) return alert('M√°ximo 3 alarmas');

    // chip
    const chip = document.createElement('span');
    chip.dataset.min = String(v);
    chip.textContent  = `${Math.abs(v)} min antes `;
    const x = document.createElement('button');
    x.type = 'button';
    x.textContent = '√ó';
    x.onclick = () => chip.remove();
    chip.appendChild(x);
    list.appendChild(chip);
  });
</script>




  </main>

  <!-- Scripts base -->
  <script src="{{ url_for('static', filename='js/supabaseClient.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='js/recetas.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='utils/calculos_ingredientes.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='js/add-activity.js') }}" type="module"></script>
  <script type="module" src="{{ url_for('static', filename='js/admin-groups.js') }}"></script>


  <!-- Script NUEVO: l√≥gica de M√∫sica (subida m√∫ltiple + parse artista/t√≠tulo) -->
  <script type="module">
    import { supabase } from "{{ url_for('static', filename='js/supabaseClient.js') }}";

    // === Config ===
    const BUCKET = 'audios'; // tu bucket de audio en Storage
    const TABLE  = 'music';  // tu tabla (id, user_id, url, title, artist, ...)

    // === Helpers ===
    const stripExt = (name) => name.replace(/\.[^/.]+$/, '');
    const parseFromFilename = (filename) => {
      const base = stripExt(filename).trim();
      const parts = base.split(/\s*[-‚Äì‚Äî]\s*/); // -, ‚Äì o ‚Äî
      if (parts.length >= 2) {
        return {
          artist: parts[0].trim() || 'Desconocido',
          title:  parts.slice(1).join(' - ').trim() || base
        };
      }
      return { artist: 'Desconocido', title: base };
    };
    async function getUserId() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user?.id) return session.user.id;
      // si no hay sesi√≥n, crea an√≥nima para tener user_id
      const { data, error } = await supabase.auth.signInAnonymously();
      if (error) return null;
      return data.user.id;
    }

    // === Refs UI ===
    const btnMusica = document.getElementById('btn-musica-actividad');
    const formMusica = document.getElementById('form-musica');
    const formIngred = document.getElementById('form-ingrediente');
    const formReceta = document.getElementById('form-receta');
    const contFormularios = document.getElementById('formularios-actividad');
    const grupoNombreDesc = document.getElementById('grupo-nombre-descripcion');
    const botonesActividad = document.getElementById('botones-actividad');

    const inputFiles = document.getElementById('musica-archivo-multiple');
    const inputTitulo = document.getElementById('musica-titulo-opcional');
    const btnSubir = document.getElementById('btn-subir-musica');
    const btnCancelar = document.getElementById('btn-cancelar-musica');
    const resultado = document.getElementById('musica-resultado');

    // === Mostrar el formulario de M√∫sica ===
    btnMusica?.addEventListener('click', () => {
      contFormularios?.classList.remove('oculto');
      // Ocultar otros
      formIngred?.classList.add('oculto');
      formReceta?.classList.add('oculto');
      // Mostrar m√∫sica
      formMusica?.classList.remove('oculto');
      // Ocultar grupos que no aplican
      grupoNombreDesc?.classList.add('oculto');
      botonesActividad?.classList.add('oculto');
      resultado.textContent = '';
    });

    // === Cancelar m√∫sica ===
    btnCancelar?.addEventListener('click', () => {
      formMusica?.classList.add('oculto');
      inputFiles.value = '';
      inputTitulo.value = '';
      resultado.textContent = '';
    });

    // === Subida m√∫ltiple ===
    btnSubir?.addEventListener('click', async () => {
      const files = inputFiles?.files || [];
      const manualTitle = (inputTitulo?.value || '').trim();

      if (!files.length) {
        resultado.textContent = '‚ùå Selecciona uno o m√°s archivos.';
        return;
      }

      const userId = await getUserId();
      if (!userId) {
        resultado.textContent = '‚ùå No hay sesi√≥n de usuario.';
        return;
      }

      btnSubir.disabled = true;
      btnSubir.textContent = 'Subiendo...';
      resultado.textContent = '';

      let ok = 0, fail = 0;
      const rows = [];

      for (const file of files) {
        try {
          const path = `${userId}/${Date.now()}_${file.name}`;
          const up = await supabase.storage.from(BUCKET).upload(path, file);
          if (up.error) throw up.error;

          const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
          const url = pub.publicUrl;

          // Si solo subes 1 y pones t√≠tulo manual, lo respetamos (y parseamos artista si viene con guion)
          let artist, title;
          if (files.length === 1 && manualTitle) {
            ({ artist, title } = parseFromFilename(`${manualTitle}.mp3`));
          } else {
            ({ artist, title } = parseFromFilename(file.name));
          }

          rows.push({ user_id: userId, url, title, artist });
          ok++;
        } catch (err) {
          console.error('Upload error', err);
          fail++;
        }
      }

      if (rows.length) {
        const { error } = await supabase.from(TABLE).insert(rows);
        if (error) {
          console.error('Insert error', error);
          resultado.textContent = `‚ö†Ô∏è Subidas OK: ${ok}, errores: ${fail}. (Fallo al guardar en tabla)`;
        } else {
          resultado.textContent = `‚úÖ Subidas OK: ${ok}, errores: ${fail}.`;
        }
      } else {
        resultado.textContent = `‚ö†Ô∏è No se pudo subir ning√∫n archivo.`;
      }

      btnSubir.disabled = false;
      btnSubir.textContent = 'Subir m√∫sica';
      inputFiles.value = '';
      inputTitulo.value = '';
    });
  </script>




</body>
</html>
