<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- VAPID public para Push (lo leen los módulos) -->
  <meta name="vapid-public" content="{{ vapid_public }}" />

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <title>Administración</title>
</head>
<body>
  <!-- Header -->
  <header class="admin-header">
    <a href="{{ url_for('html.serve_index') }}" class="admin-back">
      <i class="fas fa-arrow-left"></i><span>Volver</span>
    </a>
    <h1>Administración</h1>
  </header>

  <main class="admin-container">

    <!-- ===== Gestión rápida (Ingrediente / Receta / Música) ===== -->
    <section class="admin-section" id="admin-alimentacion-formularios">
      <h2>Gestión rápida</h2>
      <div class="admin-card">

        <!-- Botones para alternar -->
        <div class="activity-type-buttons" style="justify-content:center; gap:12px;">
          <button class="icon-button" data-type="Ingrediente" id="btn-ingrediente-actividad" type="button">
            <i class="fas fa-carrot"></i><span>Ingrediente</span>
          </button>
          <button class="icon-button" data-type="Receta" id="btn-receta-actividad" type="button">
            <i class="fas fa-utensils"></i><span>Receta</span>
          </button>
          <button class="icon-button" data-type="Musica" id="btn-musica-actividad" type="button">
            <i class="fas fa-music" style="color:#ff4d4d"></i><span>Música</span>
          </button>
        </div>

        <div class="section-content" id="form-nueva-actividad">
          <form id="nueva-actividad-formulario">
            <!-- Nombre / descripción (no aplica a música) -->
            <div id="grupo-nombre-descripcion" class="oculto">
              <div class="form-group">
                <label for="nueva-actividad-descripcion">Nombre / descripción</label>
                <input id="nueva-actividad-descripcion" type="text" placeholder="Escribe el nombre..." autocomplete="off" />
              </div>
            </div>

            <div id="formularios-actividad" class="oculto">
              <!-- Form INGREDIENTE -->
              <div class="tipo-formulario oculto" id="form-ingrediente">
                <div class="form-grid-3cols">
                  <div class="form-group">
                    <label for="ingrediente-supermercado">Supermercado:</label>
                    <select id="ingrediente-supermercado">
                      <option value="Lidl">Lidl</option>
                      <option value="Mercadona">Mercadona</option>
                      <option value="Carrefour">Carrefour</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-precio">Precio:</label>
                    <input id="ingrediente-precio" type="number" step="0.01" />
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-cantidad">Cantidad:</label>
                    <input id="ingrediente-cantidad" type="number" step="0.01" />
                  </div>
                </div>

                <div class="form-grid-3cols">
                  <div class="form-group">
                    <label for="ingrediente-unidad">Unidad:</label>
                    <select id="ingrediente-unidad">
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="unidad">unidad</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-calorias">Calorías:</label>
                    <input id="ingrediente-calorias" type="number" />
                  </div>
                  <div class="form-group">
                    <label for="ingrediente-proteinas">Proteínas:</label>
                    <input id="ingrediente-proteinas" type="number" step="0.1" />
                  </div>
                </div>
              </div>

              <!-- Form RECETA -->
              <div class="tipo-formulario oculto" id="form-receta">
                <div class="form-group">
                  <label for="receta-instrucciones">Instrucciones:</label>
                  <textarea id="receta-instrucciones" name="receta_instrucciones" placeholder="Pasos para preparar la receta..." rows="5"></textarea>
                </div>

                <div class="form-group">
                  <label>Ingredientes de la Receta:</label>
                  <div class="requirements-list" id="receta-ingredientes-container"></div>
                  <div class="add-requirement-input">
                    <select class="select-full-width" id="receta-seleccionar-ingrediente">
                      <option value="">Selecciona un ingrediente</option>
                    </select>
                    <input id="receta-cantidad-ingrediente" placeholder="Cantidad" step="0.01" type="number"/>
                    <select id="receta-unidad-ingrediente">
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="unidad">unidad</option>
                    </select>
                    <button class="btn-secondary" id="btn-añadir-ingrediente-receta" type="button">Añadir Ingrediente</button>
                  </div>
                </div>

                <div id="totales-receta" style="margin-top: 10px;">
                  <p><strong>Precio total:</strong> <span id="total-precio">0.00</span> €</p>
                  <p><strong>Calorías totales:</strong> <span id="total-calorias">0</span> kcal</p>
                  <p><strong>Proteínas totales:</strong> <span id="total-proteinas">0</span> g</p>
                </div>
              </div>

              <!-- Form MÚSICA -->
              <div class="tipo-formulario oculto" id="form-musica">
                <div class="form-group">
                  <label>Subir canciones</label>
                  <input id="musica-archivo-multiple" type="file" accept="audio/*" multiple />
                  <div class="form-text">Formato recomendado: <em>Artista - Título.mp3</em></div>
                </div>

                <div class="form-group">
                  <label>Título (opcional si subes solo 1)</label>
                  <input id="musica-titulo-opcional" type="text" placeholder="Si subes una sola, puedes forzar aquí el título" />
                </div>

                <div class="form-buttons">
                  <button class="btn-success" id="btn-subir-musica" type="button">Subir música</button>
                  <button class="btn-cancel" id="btn-cancelar-musica" type="button">Cancelar</button>
                </div>

                <div id="musica-resultado" class="form-text" style="margin-top:8px;"></div>
              </div>
              <!-- /Form MÚSICA -->
            </div>

            <!-- Botonera general (no se usa en música) -->
            <div class="form-buttons oculto" id="botones-actividad">
              <button class="btn-success btn-large" id="btn-guardar-actividad" type="submit">Guardar</button>
              <button class="btn-cancel" id="cancelar-nueva-actividad" type="button">Cancelar</button>
            </div>
          </form>
        </div>

      </div>
    </section>

    <!-- ===== Accesos de alimentación ===== -->
    <section class="admin-section" id="admin-alimentacion-accesos">
      <h2>Accesos de alimentación</h2>
      <div class="admin-card">
        <div class="admin-actions">
          <a class="admin-btn" href="/menu">
            <i class="fas fa-calendar-week"></i><span>Menú</span>
          </a>
          <a class="admin-btn" href="/despensa">
            <i class="fas fa-basket-shopping"></i><span>Despensa</span>
          </a>
          <a class="admin-btn" href="/alimentacion">
            <i class="fas fa-apple-whole"></i><span>Alimentación</span>
          </a>
        </div>
      </div>
    </section>

    <!-- ===== Productividad / Mejoras ===== -->
    <section class="admin-section" id="admin-mejoras-accesos">
      <h2>Accesos productividad</h2>
      <div class="admin-card">
        <div class="admin-actions">
          <a class="admin-btn" href="{{ url_for('html.mejoras') }}">
            <i class="fas fa-wrench"></i><span>Mejoras</span>
          </a>
          <!-- Dentro de #admin-mejoras-accesos .admin-actions -->
<a class="admin-btn" href="/gestor-actividades">
  <i class="fas fa-list-check"></i><span>Gestor de actividades</span>
</a>

        </div>
      </div>
      
    </section>

    <!-- ===== Grupo familiar ===== -->
    <section class="main-section" id="familia">
      <h2>Grupo familiar</h2>
      <div class="section-content">
        <div class="form-grid-2cols">
          <div class="form-group">
            <label>Nombre del grupo</label>
            <input id="grp-nombre" type="text" placeholder="Ej: Familia Raúl" />
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button id="grp-crear" class="btn-success">Crear grupo</button>
          </div>
        </div>

        <hr style="opacity:.2;margin:12px 0;" />

        <div id="mis-grupos"></div>

        <div id="panel-miembros" class="oculto" style="margin-top:12px;">
          <h3>Miembros del grupo: <span id="nombre-grupo-actual"></span></h3>
          <div class="form-grid-3cols">
            <div class="form-group">
              <label>Usuario (username)</label>
              <input id="mbr-username" type="text" placeholder="p.ej. derek" />
            </div>
            <div class="form-group">
              <label>Rol</label>
              <select id="mbr-rol">
                <option value="miembro">Miembro</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="mbr-agregar" class="btn-secondary">Añadir miembro</button>
            </div>
          </div>
          <ul id="lista-miembros"></ul>
        </div>
      </div>
    </section>

    <!-- ===== Notificaciones ===== -->
    <section class="admin-card" style="margin-top:1rem">
      <h2>🔔 Notificaciones</h2>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin:.5rem 0">
        <button id="btn-notify-sub" class="admin-btn">Suscribirme</button>
        <button id="btn-notify-unsub" class="admin-btn">Desuscribirme</button>
        <button id="btn-notify-test" class="admin-btn">Probar envío</button>
        <span id="notify-status" style="align-self:center">Estado: —</span>
      </div>

      <hr style="opacity:.2" />

      <h3 style="margin:.5rem 0">⏱️ Horarios por defecto</h3>
      <form id="notify-prefs" style="display:grid;grid-template-columns:180px 1fr;gap:10px;max-width:640px">
        <!-- Rutinas -->
        <h4 style="grid-column:1/-1;margin:.5rem 0 0">Rutinas</h4>
        <label for="rut_mins">Avisar minutos antes</label>
        <input id="rut_mins" type="number" min="0" step="1" value="15" />

        <!-- Tareas -->
        <h4 style="grid-column:1/-1;margin:.5rem 0 0">Tareas</h4>
        <label for="tas_mins">Avisar minutos antes</label>
        <input id="tas_mins" type="number" min="0" step="1" value="15" />

        <!-- Citas -->
        <h4 style="grid-column:1/-1;margin:.5rem 0 0">Citas</h4>
        <div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:10px">
          <label><input type="checkbox" class="apt_preset" data-min="-43200" /> 1 mes</label>
          <label><input type="checkbox" class="apt_preset" data-min="-21600" /> 15 días</label>
          <label><input type="checkbox" class="apt_preset" data-min="-1440" /> 1 día</label>
          <label><input type="checkbox" class="apt_preset" data-min="-60" /> 1 hora</label>
        </div>

        <label for="apt_custom_val">Personalizada</label>
        <div>
          <input id="apt_custom_val" type="number" min="1" step="1" value="30" style="width:120px" />
          <select id="apt_custom_unit">
            <option value="min">min</option>
            <option value="h">horas</option>
            <option value="d">días</option>
          </select>
          <button type="button" id="apt_add" class="admin-btn" style="margin-left:8px">Añadir alarma</button>
          <small style="margin-left:8px;opacity:.7">(máx. 3 en total)</small>
        </div>

        <div style="grid-column:1/-1">
          <div id="apt_list" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <div></div>
        <button class="admin-btn" type="submit">Guardar</button>
      </form>
    </section>

  </main>

  <!-- === Scripts base existentes === -->
  <script src="{{ url_for('static', filename='js/supabaseClient.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='js/recetas.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='utils/calculos_ingredientes.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='js/add-activity.js') }}" type="module"></script>
  <script src="{{ url_for('static', filename='js/admin-groups.js') }}" type="module"></script>

  <!-- === NUEVOS módulos admin (separados) === -->
  <script type="module" src="{{ url_for('static', filename='js/admin/sw-register.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/admin/push.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/admin/prefs.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/admin/music.js') }}"></script>
</body>
</html>
