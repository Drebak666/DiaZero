<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Mi Agenda</title>








<script>
  // Solo si no est√° ya establecido
  if (!localStorage.getItem("usuario_actual")) {
    localStorage.setItem("usuario_actual", localStorage.getItem("username"));
  }
</script>

<!-- Font Awesome para los iconos -->
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<!-- Enlace a tu hoja de estilos principal -->
<link href="/static/css/style.css" rel="stylesheet"/>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

</head>

<body>
<header style="margin-top:45px; text-align:center;">
  <span id="nombre-usuario" 
        style="display:inline-block; width:100%; max-width:600px; padding:10px; background:#0f172a; border:2px solid #00f5ff; border-radius:8px; color:white; font-weight:bold;">
    Usuario
  </span>
</header>



<main>
<section class="admin-card">
  <div class="section-content">
    <div id="ultimas-citas"><em>Cargando‚Ä¶</em></div>
  </div>
</section>





    <!-- Form edici√≥n tarea -->
    <!-- Form edici√≥n tarea -->
<!-- Form edici√≥n tarea -->
<div class="oculto form-modal" id="form-editar-tarea">
  <h3>Editar Tarea</h3>
  <form id="editar-formulario-tarea" class="form-editar-cita">
    <input id="editar-id-tarea" type="hidden" />
    <input id="editar-tipo" type="hidden" />

    <div class="form-group">
      <label for="editar-descripcion-tarea">Descripci√≥n:</label>
      <input id="editar-descripcion-tarea" type="text" placeholder="Descripci√≥n" />
    </div>

    <!-- Fecha + Hora de inicio en una sola fila -->
    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="editar-fecha-tarea">Fecha:</label>
        <input id="editar-fecha-tarea" type="date" />
      </div>
      <div class="form-group">
        <label for="editar-hora-inicio-tarea">Hora de Inicio:</label>
        <input id="editar-hora-inicio-tarea" type="time" />
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" class="btn-success">Guardar Cambios</button>
      <button type="button" id="recoger-edicion-tarea" class="btn-cancel">Recoger</button>
    </div>
  </form>
</div>


  </section>

  <!-- A√±adir Actividad -->
  <section class="main-section" id="a√±adir-actividad">
    <div class="section-content" id="form-nueva-actividad">
      <form id="nueva-actividad-formulario">
        <div class="activity-type-buttons">
          <button class="icon-button" data-type="Tarea" id="btn-tarea-actividad"><i class="fas fa-clipboard-list"></i></button>
          <button class="icon-button" data-type="Rutina" id="btn-rutina-actividad"><i class="fas fa-redo-alt"></i></button>
          <button class="icon-button" data-type="Cita" id="btn-cita-actividad"><i class="fas fa-calendar-alt"></i></button>

          <button class="icon-button nota-btn" id="btn-nota-actividad" type="button">
            <i class="fas fa-sticky-note" style="color:red;"></i>
            <span class="badge-nota" id="contador-notas">0</span>
          </button>

          <a class="icon-button lista-btn" id="btn-lista" href="/lista-compra" title="Lista de compra">
            <i class="fas fa-list"></i>
            <span class="badge-lista" id="contador-lista">0</span>
          </a>
        </div>

        <div class="activity-quick-input">
          <div class="form-group">
            <input id="nueva-actividad-descripcion" type="text" placeholder="A√±adir una nueva tarea, rutina o cita..." />
          </div>
        </div>

        <div class="oculto" id="formularios-actividad">
          <!-- Tarea -->
          <div class="tipo-formulario oculto" id="form-tarea">
           <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="tarea">
    <option value="">‚Äî Ninguno ‚Äî</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="tarea-fecha">Fecha:</label>
                <input id="tarea-fecha" name="tarea_fecha" type="date"/>
              </div>
          
              <div class="form-group">
                <label for="tarea-hora-inicio">Hora de Inicio:</label>
                <input id="tarea-hora-inicio" name="tarea_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="tarea-hora-fin">Hora de Fin:</label>
                <input id="tarea-hora-fin" name="tarea_hora_fin" type="time"/>
              </div>
            </div>
          </div>

          <!-- Rutina -->
          <div class="tipo-formulario oculto" id="form-rutina">
<div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="rutina">
    <option value="">‚Äî Ninguno ‚Äî</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-fecha">Fecha:</label>
                <input id="rutina-fecha" name="rutina_fecha" type="date"/>
              </div>
              <div class="form-group">
                <label for="rutina-fecha-fin">Fecha Fin:</label>
                <input id="rutina-fecha-fin" name="rutina_fecha_fin" type="date"/>
              </div>
              
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-hora-inicio">Hora Inicio:</label>
                <input id="rutina-hora-inicio" name="rutina_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="rutina-hora-fin">Hora Fin:</label>
                <input id="rutina-hora-fin" name="rutina_hora_fin" type="time"/>
              </div>
            </div>
            <div class="form-group dias-checkboxes">
              <label>D√≠as:</label>
              <div class="dias-semana-wrapper">
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Lunes"> L</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Martes"> M</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Mi√©rcoles"> X</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Jueves"> J</label>
                </div>
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Viernes"> V</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="S√°bado"> S</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Domingo"> D</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Cita -->
          <div class="tipo-formulario oculto" id="form-cita">
          <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="cita">
    <option value="">‚Äî Ninguno ‚Äî</option>
  </select>
</div>

            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-hora-inicio">Hora de Inicio:</label>
                <input id="cita-hora-inicio" name="cita_hora_inicio" type="time" />
              </div>
              <div class="form-group">
                <label for="cita-hora-fin">Hora de Fin:</label>
                <input id="cita-hora-fin" name="cita_hora_fin" type="time" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-fecha">Fecha:</label>
                <input id="cita-fecha" name="cita_fecha" type="date" />
              </div>
              <div class="form-group">
                <label for="nuevo-requisito-cita">A√±adir Requisito:</label>
                <input type="text" id="nuevo-requisito-cita" placeholder="Ej: DNI, Informe m√©dico" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group centrado-boton">
                <button type="button" id="btn-a√±adir-requisito-cita" class="btn-secondary">A√±adir requisito</button>
              </div>
              <div class="form-group">
                <details class="requisitos-accordion" id="cita-requisitos-accordion">
                  <summary>Requisitos</summary>
                  <div class="requirements-list" id="cita-requisitos-container"></div>
                </details>
              </div>
            </div>
          </div>




        <div class="form-buttons oculto" id="botones-actividad">
          <button class="btn-success btn-large" id="btn-guardar-actividad" type="submit">Guardar</button>
          <button class="btn-cancel" id="cancelar-nueva-actividad" type="button">Cancelar</button>
        </div>
      </form>
    </div>


<!-- Modal: Editar Cita (completo) -->
<div class="form-modal oculto" id="modal-editar-cita">
  <form id="form-editar-cita" class="form-editar-cita">
    <h3>Editar Cita</h3>
    <input type="hidden" id="edit-cita-id" />

    <div class="form-group">
      <label for="edit-cita-desc">Descripci√≥n:</label>
      <input id="edit-cita-desc" type="text" placeholder="Descripci√≥n de la cita" />
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-fecha">Fecha:</label>
        <input id="edit-cita-fecha" type="date" />
      </div>
      <div class="form-group">
        <label for="edit-cita-inicio">Hora de Inicio:</label>
        <input id="edit-cita-inicio" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-req-input">A√±adir Requisito:</label>
        <input id="edit-cita-req-input" type="text" placeholder="Ej: DNI, Informe m√©dico" />
      </div>
      <div class="form-group">
        <label for="edit-cita-fin">Hora de Fin:</label>
        <input id="edit-cita-fin" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols" style="align-items:flex-start;">
      <div class="form-group" style="grid-column:1 / span 1;">
        <div id="edit-cita-req-list" class="req-chip-box"></div>
      </div>
      <div class="form-group" style="display:flex; align-items:flex-start; justify-content:flex-end;">
        <button type="button" id="btn-add-req" class="btn-secondary" style="min-width:180px;">A√±adir requisito</button>
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" class="btn-success">Guardar Cambios</button>
      <button type="button" id="cerrar-modal-cita" class="btn-cancel">Recoger</button>
    </div>
  </form>
</div>

<!-- Modal: Compartir -->
<div class="form-modal oculto" id="modal-compartir">
  <form id="form-compartir">
    <h3>Compartir</h3>
    <!-- üëá A√ëADE ESTE HIDDEN -->
    <input type="hidden" id="share-ids" />
    <input type="hidden" id="share-id" />

    <div class="form-grid-2cols">
      <div class="form-group">
        <label>Grupo</label>
        <select id="share-grupo">
          <option value="">‚Äî Ninguno ‚Äî</option>
        </select>
      </div>

      <div class="form-group">
        <label>Personas</label>
        <div id="share-personas" class="checklist"></div>
      </div>
    </div>

    <div class="form-buttons" style="gap:8px;">
      <button type="button" id="share-clear" class="btn-cancel">Quitar todo</button>
      <div style="flex:1"></div>
      <button type="button" id="share-cancel" class="btn-cancel">Cancelar</button>
      <button type="submit" class="btn-success">Guardar</button>
    </div>
  </form>
</div>

  </section>

  <!-- Agenda de Hoy -->
  <section class="main-section" id="agenda-de-hoy">
    <div class="section-content" id="agenda-container"></div>
  </section>

  <!-- Comida de Hoy (sin carrusel) -->
  <section class="main-section" id="comida-de-hoy">
    <div class="section-content" id="comida-container"></div>
  </section>

  <!-- Navegaci√≥n (GRID 3 columnas, sin carrusel) -->
<section class="main-section" id="navegacion">
  <h2>NAVEGACI√ìN</h2>
  <div class="section-content">
<div class="nav-grid" style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; justify-items:center;">
      <a class="icon-button" href="/reproductor"><i class="fas fa-music"></i><span>Audio</span></a>
      <a class="icon-button" href="/documentos"><i class="fas fa-file-alt"></i><span>Docs</span></a>
      <a class="icon-button" href="/registro"><i class="fas fa-clipboard-check"></i><span>Registro</span></a>
      <a class="icon-button" href="/calendario"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
      <a class="icon-button" href="/ejercicio"><i class="fas fa-dumbbell"></i><span>Ejercicio</span></a>
      <a class="icon-button" href="/contactos" id="btn-contactos" title="Contactos">

  <i class="fas fa-address-book"></i><span>Contactos</span>
</a>

      <!-- ====== SCRIPTS ====== -->

<script type="module" src="/static/js/gestor-actividades.js"></script>
<script type="module" src="/static/js/admin-groups.js"></script>

 
       
     
       
     
     
     




      <!-- Bot√≥n de cerrar sesi√≥n abajo -->
      <button id="cerrar-sesion" class="icon-button" style="background-color:red; border:none; cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i><span>Cerrar sesi√≥n</span>
      </button>
      


    </div>
  </div>
</section>


  <!-- Acceso Administraci√≥n -->
  <section class="main-section" id="admin-acceso">
    <a href="/admin" class="btn-admin-wide">
      <i class="fas fa-cog"></i>
      <span>Administraci√≥n</span>
    </a>
  </section>

  
</main>

<footer></footer>

<!-- Scripts -->
 
<script src="{{ url_for('static', filename='js/supabaseClient.js') }}" type="module"></script>


<script type="module">
  import { getUID } from "{{ url_for('static', filename='js/supabaseClient.js') }}";
  await getUID();            // deja window.UID listo para TODOS los fetch
</script>


<script src="{{ url_for('static', filename='js/main.js') }}" type="module"></script>
<script type="module" src="{{ url_for('static', filename='js/ultimas-citas.js') }}"></script>
{% if cargar_add_activity %}
  <script src="{{ url_for('static', filename='js/add-activity.js') }}" type="module"></script>
{% endif %}
<script src="{{ url_for('static', filename='js/today-agenda.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/recetas.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/comida_dia.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/usuario.js') }}" type="module"></script>





<!-- Asegurar sesi√≥n + decidir si mostrar Admin -->
<script type="module">
  import { supabase } from "{{ url_for('static', filename='js/supabaseClient.js') }}";
  
  const ADMIN_SELECTORS = ['#admin-acceso', '#admin-btn'];
  const hideAdminUI = () => ADMIN_SELECTORS.forEach(sel => document.querySelector(sel)?.classList.add('oculto'));

  (async () => {
    const username = localStorage.getItem('usuario_actual');
    if (!username) return hideAdminUI();

    try {
      await fetch('/api/ensure-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username })
      });
    } catch (_) { /* no bloquear */ }

    const { data, error } = await supabase
      .from('usuarios')
      .select('role')
      .eq('username', username)
      .maybeSingle();

    if (error || !data || data.role !== 'admin') hideAdminUI();
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("usuario_actual");
  if (username) {
    document.getElementById("nombre-usuario").textContent = username;
  }
});
</script>
<script>
  if (!location.pathname.startsWith('/app')) {
    if (localStorage.getItem('modo_continuo') !== 'on') {
      localStorage.setItem('modo_continuo', 'on');
      const to = location.pathname + location.search + location.hash;
      location.replace('/app?to=' + encodeURIComponent(to));
    }
  }
</script>







<script>

document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modal-compartir');
  if (!modal) return;

  const cancelBtn = document.getElementById('share-cancel');
  cancelBtn.addEventListener('click', () => {
    modal.classList.add('oculto');
  });
});

</script>

<!-- Flecha NAV (inline para saltar cach√© y subir z-index) -->
<!-- Flecha NAV (auto ‚Üì/‚Üë con IntersectionObserver) -->
<style>
  .nav-shortcut{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(16px + env(safe-area-inset-bottom,0));
    z-index: 99999; /* por encima de todo (shell, mini-player, etc.) */
  }
  .nav-shortcut button{
    width: 46px; height: 46px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(17,24,39,.9); color:#e5e7eb;
    display:flex; align-items:center; justify-content:center;
    box-shadow: 0 6px 20px rgba(0,0,0,.35);
    backdrop-filter: blur(6px); cursor:pointer;
    transition: background .2s;
  }
  .nav-shortcut button:hover{ background: rgba(51,65,85,.95); }
</style>

<div class="nav-shortcut" aria-label="Ir a la navegaci√≥n">
  <button id="nav-toggle-btn" title="Ir a Navegaci√≥n">
    <i class="fa-solid fa-angles-down"></i>
  </button>
</div>

<script>
(() => {
  const btn = document.getElementById('nav-toggle-btn');
  const nav = document.getElementById('navegacion');
  if (!btn || !nav) return;

  const DOWN = '<i class="fa-solid fa-angles-down"></i>';
  const UP   = '<i class="fa-solid fa-angles-up"></i>';
  const smooth = { behavior: 'smooth', block: 'start' };
  const noMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  let atNav = false; // ¬ønavegaci√≥n visible?

  // Observa si #navegacion entra/sale de la vista (40% visible = ‚Äúestamos en navegaci√≥n‚Äù)
  const io = new IntersectionObserver((entries) => {
    const e = entries[0];
    atNav = e.isIntersecting && e.intersectionRatio >= 0.4;
    btn.innerHTML = atNav ? UP : DOWN;
    btn.title     = atNav ? 'Volver arriba' : 'Ir a Navegaci√≥n';
  }, { root: null, threshold: [0, .4, .6, 1] });

  io.observe(nav);

  // Click: baja si est√°s arriba; sube si ya est√°s en navegaci√≥n
  btn.addEventListener('click', () => {
    if (atNav) {
      window.scrollTo({ top: 0, behavior: noMotion ? 'auto' : 'smooth' });
    } else {
      if (noMotion) nav.scrollIntoView(); else nav.scrollIntoView(smooth);
    }
  });

  // Ajuste inicial por si cargas ya cerca de navegaci√≥n
  requestAnimationFrame(() => {
    // Forzamos primera evaluaci√≥n
    const rect = nav.getBoundingClientRect();
    atNav = rect.top < window.innerHeight * 0.6;
    btn.innerHTML = atNav ? UP : DOWN;
    btn.title     = atNav ? 'Volver arriba' : 'Ir a Navegaci√≥n';
  });
})();
</script>

<!-- =========================================================
     VOZ / MICRO ‚Äî RECEPTOR √öNICO (todo en uno)
     - Inserta por Supabase: notas, tasks, routines, appointments
     - Defaults:
         * tarea: hoy + (ahora+1h)
         * rutina: hoy, start=(ahora+1h), end=start+1h, diaria
         * cita:   hoy, start=(ahora+1h), end=start+1h
     - Dedupe: evita repetir comando (<2s) y duplica en BD (SELECT previo)
     - Soft refresh de la UI + Realtime (si est√° activado en Supabase)
   ========================================================= -->
<script>
(() => {
  if (window.__voiceReceiverInstalled) return;
  window.__voiceReceiverInstalled = true;

  // ---------- CONFIG (IDs a refrescar tras crear) ----------
  const REFRESH_IDS = [
    'agenda-container',
    'ultimas-citas',
    // 'notas-container',
    // 'tareas-container',
  ];

  // ---------- HELPERS ----------
  const getSB = () => (window.supabase || window.sb || window.supabaseClient);

  // fecha local "YYYY-MM-DD" (sin UTC)
  const isoDate = (d) => {
    if (!d) return null;
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };

  // "HH:MM" -> "HH:MM:SS"
  const padSec = t => !t ? null : (/^\d{1,2}:\d{2}$/.test(t) ? (t + ':00') : t);

  // hoy local
  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  // hora por defecto: ahora +1h (clamp a 23:59 para no cambiar de d√≠a)
  function defaultStartTimePlus1h() {
    const now = new Date();
    const plus = new Date(now.getTime() + 60 * 60000);
    let hh = plus.getHours();
    let mm = plus.getMinutes();
    if (plus.getDate() !== now.getDate()) { hh = 23; mm = 59; }
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`;
  }

  // suma +1h a "HH:MM[:SS]" (clamp 23:59:00)
  function add1hClamp(t) {
    if (!t) return null;
    const [hh, mm, ss='00'] = t.split(':').map(x => parseInt(x,10));
    let h2 = hh + 1, m2 = mm, s2 = ss || 0;
    if (h2 >= 24) { h2 = 23; m2 = 59; s2 = 0; }
    return `${String(h2).padStart(2,'0')}:${String(m2).padStart(2,'0')}:${String(s2).padStart(2,'0')}`;
  }

    // ===== Lista de la compra: helpers =====
  // Cacheamos el set de ingredientes para no pedirlo cada vez
  let __ING_SET = null;
  async function getIngredientSet(){
    if (__ING_SET) return __ING_SET;
    const sb = getSB();
    __ING_SET = new Set();
    if (!sb?.from) return __ING_SET;

    // intenta distintas tablas conocidas; la primera que responda
    const candidates = [
      { table: 'ingredientes_base', col: 'nombre' },
      { table: 'ingredientes',      col: 'nombre' },
      { table: 'ingredientes_lista',col: 'nombre' },
    ];
    for (const {table,col} of candidates){
      const { data, error } = await sb.from(table).select(col).limit(2000);
      if (!error && Array.isArray(data)) {
        data.forEach(r => r?.[col] && __ING_SET.add(String(r[col]).toLowerCase().trim()));
        if (__ING_SET.size) break;
      }
    }
    return __ING_SET;
  }

  // Normaliza texto
  const nrm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

  // Extrae cantidad/unidad si viene pegado al √≠tem
  function pickQtyUnit(str){
    const x = nrm(str);
    const m = x.match(/(?:^|\s)(\d+(?:[.,]\d+)?)\s*(kg|g|gr|gramos|l|ml|cc|ud|uds|unidad(?:es)?|paquete(?:s)?|lata(?:s)?|bote(?:s)?|pieza(?:s)?)(?:\s|$)/);
    if (!m) return { nombre: str.trim(), cantidad:null, unidad:null };
    let cantidad = parseFloat(m[1].replace(',','.'));
    const u0 = m[2];
    const unidad = ({
      kg:'kg', g:'g', gr:'g', gramos:'g',
      l:'l', ml:'ml', cc:'ml',
      ud:'ud', uds:'ud', unidad:'ud', unidades:'ud',
      paquete:'paquete', paquetes:'paquete',
      lata:'lata', latas:'lata',
      bote:'bote', botes:'bote',
      pieza:'pieza', piezas:'pieza'
    })[u0] || u0;

    const nombre = x.replace(m[0],' ').replace(/\s{2,}/g,' ').trim();
    return { nombre, cantidad, unidad };
  }

  // Partir en items con reglas:
  // 1) Si hay comas o " y " / " e " ‚Üí usar eso como separador
  // 2) Si no, troceo por tokens con nexos (de/del/con/sin) y buscando ingredientes compuestos conocidos
  async function splitShoppingText(text){
    const ING = await getIngredientSet();
    let s = ' ' + nrm(text) + ' ';

    // Prioriza separadores expl√≠citos
    const hasSep = /,|;|\sy\s|\se\s/.test(s);
    if (hasSep){
      s = s.replace(/\s+y\s+|\s+e\s+/g, ',');
      return s.split(',').map(t=>t.trim()).filter(Boolean);
    }

    // Sin separadores: greedy por ingredientes + nexos
    const tokens = s.trim().split(/\s+/);
    const items = [];
    const NEXOS = new Set(['de','del','con','sin']);
    for (let i=0; i<tokens.length; ){
      // buscar el ingrediente m√°s largo empezando en i (hasta 5 tokens)
      let best = null, bestLen = 0;
      for (let len = Math.min(5, tokens.length - i); len >= 2; len--){
        const cand = tokens.slice(i, i+len).join(' ');
        if (ING.has(cand)) { best = cand; bestLen = len; break; }
      }
      if (best){
        items.push(best);
        i += bestLen;
        continue;
      }
      // une patron "X de Y" / "X del Y" / "X con Y" / "X sin Y"
      if (i+2 < tokens.length && NEXOS.has(tokens[i+1])){
        items.push(tokens[i] + ' ' + tokens[i+1] + ' ' + tokens[i+2]);
        i += 3;
        continue;
      }
      // por defecto: palabra suelta
      items.push(tokens[i]);
      i++;
    }

    // juntar restos tipo "400 g" que hayan quedado en item siguiente
    // (lo arregla pickQtyUnit de todas formas, pero ayuda)
    return items.map(t=>t.trim()).filter(Boolean);
  }

  // soft refresh de secciones sin F5
async function refreshUIAfterChange(type, row) {
  // Evita bucles de recarga
  if (window.__voiceSoftReloading) return;
  let didSomething = false;

  try {
    // Llama a cualquier helper que tengas (pon aqu√≠ los tuyos reales)
    if (typeof window.recargarNotas === 'function') {
      await window.recargarNotas(); didSomething = true;
    }
    if (typeof window.cargarAgenda === 'function') {
      await window.cargarAgenda(); didSomething = true;
    }
    if (typeof window.cargarDia === 'function') {
      // intenta refrescar el d√≠a afectado si viene en el row
      const d = row?.due_date || row?.date || null;
      await window.cargarDia?.(d); didSomething = true;
    }
    if (typeof window.cargarUltimasCitas === 'function') {
      await window.cargarUltimasCitas(); didSomething = true;
    }

    // Evento por si otra parte de tu app escucha
    document.dispatchEvent(new CustomEvent('voice:db-change', {
      detail: { type, row }
    }));
  } catch (e) {
    console.warn('[voice] refresh helpers error:', e);
  }

  // Si no hubo ning√∫n helper, fuerza una recarga 1 sola vez
  if (!didSomething) {
    window.__voiceSoftReloading = true;
    setTimeout(() => { location.reload(); }, 100); // ‚Äúauto-F5‚Äù
  }
}
  // inserta si no existe ya (dedupe en BD)
  async function insertIfNotExists({ table, match, build }) {
    const sb = getSB();
    if (!sb?.from) throw new Error('Supabase no inicializado');

    // owner_id (si usas RLS)
    let owner_id = null;
    try { owner_id = (await sb.auth.getUser())?.data?.user?.id || null; } catch {}

    const row = build(owner_id);

    let q = sb.from(table).select('id').limit(1);
    for (const [k,v] of Object.entries(match(row))) {
      q = (v === null) ? q.is(k, null) : q.eq(k, v);
    }
    const { data: dup, error: selErr } = await q;
    if (selErr) throw selErr;
    if (dup && dup.length) {
      console.warn(`‚õî [voice] Duplicado en ${table}, no inserto`, match(row));
      return { skipped: true };
    }

    const { error: insErr } = await sb.from(table).insert([ row ]);
    if (insErr) throw insErr;
    return { ok: true, row };
  }

  // ---------- CREAR ENTIDAD ----------
  // dedupe de comando (<2s)
  let lastSig = null, lastTs = 0;
  const sameSig = (a,b) => a && b && a.type===b.type && a.text===b.text && a.date===b.date && a.time===b.time;

// --- Helpers para n√∫meros por voz y separar nombre/tel√©fono ---
function _norm(s){ return (s||'').toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[.,;:()\-_/+]/g,' ').replace(/\s+/g,' ').trim(); }

const UNITS = {cero:'0',uno:'1',una:'1',un:'1',dos:'2',tres:'3',cuatro:'4',cinco:'5',seis:'6',siete:'7',ocho:'8',nueve:'9'};
const TEENS = {diez:'10',once:'11',doce:'12',trece:'13',catorce:'14',quince:'15',
               dieciseis:'16',diecisiete:'17',dieciocho:'18',diecinueve:'19'};
const TENS  = {veinte:20,treinta:30,cuarenta:40,cincuenta:50,sesenta:60,setenta:70,ochenta:80,noventa:90};

async function llamarPorVoz(payload){
  const sb = (window.supabase || window.sb || window.supabaseClient);
  const t = (payload || '').replace(/^\s*a\s+/i,'').trim(); // quita "a" inicial si dices "llamar a ..."

  // 1) ¬øEs un n√∫mero dicho en palabras? ‚Üí convi√©rtelo
  let num = (typeof palabrasANumero === 'function') ? palabrasANumero(t) : t.replace(/\s+/g,'');
  // normaliza prefijo 34 ‚Üí +34XXXXXXXXX (opcional)
  if (/^34\d{9}$/.test(num)) num = '+' + num;

  if (/^\+?\d{6,15}$/.test(num)) {
    window.location.href = 'tel:' + num;
    return;
  }

  // 2) Si no, busca por nombre en 'contactos'
  if (!sb?.from) { alert('No hay conexi√≥n con Supabase'); return; }

  const { data, error } = await sb
    .from('contactos')
    .select('id,nombre,telefono')
    .ilike('nombre', t + '%')
    .order('nombre', { ascending: true })
    .limit(5);

  if (error || !data?.length) { alert('No encuentro contacto: ' + t); return; }

  const conTel = data.filter(c => c.telefono);
  if (!conTel.length) { alert('Ese contacto no tiene tel√©fono guardado.'); return; }

  const elegido = conTel[0]; // el primero que coincida
  window.location.href = 'tel:' + String(elegido.telefono).trim();
}

// Convierte "seis doce treinta y cuatro..." en "61234"
function palabrasANumero(str){
  const t = _norm(str).split(' ');
  let out = '';
  for (let i=0;i<t.length;i++){
    const w = t[i];
    if (/^\d+$/.test(w)) { out += w; continue; }                  // ya d√≠gitos
    if (UNITS[w])        { out += UNITS[w]; continue; }           // 0‚Äì9
    if (TEENS[w])        { out += TEENS[w]; continue; }           // 10‚Äì19
    if (w.startsWith('veinti')) {                                 // veintiuno...
      const u = w.replace(/^veinti/,''); if (UNITS[u]) out += '2'+UNITS[u];
      continue;
    }
    if (TENS[w]){                                                 // treinta (y) dos
      if (t[i+1]==='y' && UNITS[t[i+2]]) { out += String(TENS[w]+Number(UNITS[t[i+2]])); i+=2; }
      else { out += String(TENS[w]); }
      continue;
    }
    // ignora conectores
    if (['y','guion','gion','numero','n√∫mero','mas','plus','slash','barra','espacio'].includes(w)) continue;
  }
  // Limpia espacios residuales
  return out.replace(/\s+/g,'');
}

const NUMBER_WORDS = new Set([
  ...Object.keys(UNITS), ...Object.keys(TEENS), ...Object.keys(TENS),
  'veintiuno','veintidos','veintitres','veinticuatro','veinticinco','veintiseis','veintisiete','veintiocho','veintinueve',
  'y','guion','gion','numero','n√∫mero','mas','plus','slash','barra','espacio'
]);

// Separa ‚ÄúAna Mar√≠a seis doce‚Ä¶‚Äù -> { nombre:"Ana Mar√≠a", numeroTexto:"seis doce‚Ä¶" }
function splitNombreTelefono(text){
  const raw = text.trim();
  const normalized = _norm(raw).split(' ');
  let idx = normalized.findIndex(tok => /^\d+$/.test(tok) || NUMBER_WORDS.has(tok) || tok.startsWith('veinti'));
  if (idx === -1) return { nombre: raw, numeroTexto: '' };
  // reconstruye nombre usando las palabras originales para mantener may√∫sculas
  const origParts = raw.split(/\s+/);
  const nombre = origParts.slice(0, idx).join(' ') || 'SinNombre';
  const numeroTexto = origParts.slice(idx).join(' ');
  return { nombre, numeroTexto };
}



  async function crearEntidad(intent){
    const { type, text, date, time } = intent;
        // CONTACTO -> 'contactos'
    if (type === 'contacto') {
  const { nombre, numeroTexto } = splitNombreTelefono(text);
  const telefono = palabrasANumero(numeroTexto);
  const r = await insertIfNotExists({
    table: 'contactos',
    build: (owner_id) => ({ nombre, telefono, owner_id }),
    match: (row) => ({ nombre: row.nombre, telefono: row.telefono, owner_id: row.owner_id })
  });
  if (r?.ok) refreshUIAfterChange('contacto', r.row);
  return;
  
}

if (type === 'llamar') {
  await llamarPorVoz(text);
  return;
}

    if (!text) throw new Error('Sin texto');

    // Si tu app ya tiene helpers, se respetan
    if (type==='nota'  && typeof window.addNota  === 'function')  return window.addNota({ descripcion:text });
    if (type==='tarea' && typeof window.addTarea === 'function')  return window.addTarea({ description:text, due_date: isoDate(date)||todayISO(), start_time: padSec(time)||defaultStartTimePlus1h() });
    if (type==='rutina'&& typeof window.addRutina=== 'function')  return window.addRutina({ description:text, date: isoDate(date)||todayISO(), start_time: padSec(time)||defaultStartTimePlus1h(), end_time: add1hClamp(padSec(time)||defaultStartTimePlus1h()) });
    if (type==='cita'  && typeof window.addCita  === 'function')  return window.addCita({ descripcion:text, fecha: isoDate(date)||todayISO(), hora: padSec(time)||defaultStartTimePlus1h() });

       // COMPRA -> 'lista_compra' (inserci√≥n en lote con dedupe)
if (type === 'compra') {
  const sb = getSB();
  if (!sb?.from) throw new Error('Supabase no inicializado');

  // 1) Partimos el texto en items (respeta "de/del/con/sin" y ‚Äúarena de gato‚Äù)
  const items = await splitShoppingText(text);
  if (!items.length) return;

  // 2) Normalizamos cantidad/unidad de cada item
  const rows = [];
  for (const raw of items) {
    const { nombre, cantidad, unidad } = pickQtyUnit(raw);
    if (!nombre) continue;
    rows.push({ nombre, cantidad: cantidad ?? null, unidad: unidad ?? null });
  }
  if (!rows.length) return;

  // 3) Obtenemos usuario y lo a√±adimos a todos los rows
  let owner_id = null;
  try { owner_id = (await sb.auth.getUser())?.data?.user?.id || null; } catch {}
rows.forEach(r => { r.owner_id = owner_id; r.completado = false; });

  // 4) Dedupe local: quitamos duplicados del mismo comando
  const seen = new Set();
  const uniqueRows = rows.filter(r => {
    const k = `${r.nombre.toLowerCase().trim()}|${r.unidad || ''}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });

  // 5) Dedupe contra la BD (pendientes del usuario)
  const { data: actuales, error: selErr } = await sb
 .from('lista_compra')
 .select('nombre, unidad')
 .eq('owner_id', owner_id)
 .eq('completado', false);

  const ya = new Set((actuales || []).map(i => `${(i.nombre||'').toLowerCase().trim()}|${i.unidad||''}`));
  const aInsertar = uniqueRows.filter(r => !ya.has(`${r.nombre.toLowerCase().trim()}|${r.unidad||''}`));

  if (!aInsertar.length) { console.log('üõí [voice] Nada que insertar (todo ya estaba)'); return; }

  // 6) Inserci√≥n en lote (una sola llamada)
  const { error: insErr } = await sb.from('lista_compra').insert(aInsertar);
  if (insErr) throw insErr;

  // 7) Refresco suave de UI
  window.updateShoppingBadge?.();
  for (const row of aInsertar) {
    refreshUIAfterChange('compra', row);
  }
  return;
}

    // NOTA -> 'notas'
    if (type === 'nota') {
      const r = await insertIfNotExists({
        table: 'notas',
        build: (owner_id) => ({ descripcion: text, owner_id }),
        match: (row) => ({ descripcion: row.descripcion, owner_id: row.owner_id })
      });
      if (r?.ok) refreshUIAfterChange('nota', r.row);
      return;
    }

    // TAREA -> 'tasks' (hoy +1h por defecto)
    if (type === 'tarea') {
      const d = isoDate(date) || todayISO();
      const t = padSec(time) || defaultStartTimePlus1h();
      const r = await insertIfNotExists({
        table: 'tasks',
        build: (owner_id) => ({
          description: text,
          due_date: d,
          start_time: t,
          end_time: null,
          is_completed: false,
          owner_id
        }),
        match: (row) => ({
          description: row.description,
          due_date: row.due_date,
          start_time: row.start_time || null,
          owner_id: row.owner_id
        })
      });
      if (r?.ok) refreshUIAfterChange('tarea', { ...r.row, due_date:d, start_time:t, description:text });
      return;
    }

    // RUTINA -> 'routines' (hoy, start +1h, fin +1h, diario)
    if (type === 'rutina') {
      const d = isoDate(date) || todayISO();
      const start = padSec(time) || defaultStartTimePlus1h();
      const end   = add1hClamp(start);
      const r = await insertIfNotExists({
        table: 'routines', // cambia a 'rutinas' si tu tabla se llama as√≠
        build: (owner_id) => ({
          description: text,
          date: d,
          start_time: start,
          end_time: end,
          days_of_week: ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"],
          is_active: true,
          is_completed: false,
          owner_id
        }),
        match: (row) => ({
          description: row.description,
          date: row.date,
          start_time: row.start_time,
          owner_id: row.owner_id
        })
      });
      if (r?.ok) refreshUIAfterChange('rutina', { ...r.row, date:d, start_time:start, end_time:end, description:text });
      return;
    }

    // CITA -> 'appointments' (hoy, start +1h, fin +1h)
    if (type === 'cita') {
      const d = isoDate(date) || todayISO();
      const start = padSec(time) || defaultStartTimePlus1h();
      const end   = add1hClamp(start);
      const r = await insertIfNotExists({
        table: 'appointments',
        build: (owner_id) => ({
          description: text,
          date: d,
          start_time: start,
          end_time: end,
          owner_id
        }),
        match: (row) => ({
          description: row.description,
          date: row.date,
          start_time: row.start_time,
          owner_id: row.owner_id
        })
      });
      if (r?.ok) refreshUIAfterChange('cita', { ...r.row, date:d, start_time:start, end_time:end, description:text });
      return;
    }

    throw new Error('Tipo no soportado: ' + type);
  }

  // ---------- Receptor desde el SHELL ----------
  window.addEventListener('message', async (event) => {
    const msg = event.data || {};
    if (msg.action !== 'voice-create') return;

    const { type, text, date, time } = msg.payload || {};
    if (!type || !text) return;

    const sig = { type, text, date: date||null, time: time||null };
    const now = Date.now();
    if (lastSig && sameSig(sig, lastSig) && (now - lastTs) < 2000) {
      console.warn('‚õî Ignorado duplicado reciente', sig);
      return;
    }
    lastSig = sig; lastTs = now;

    try {
      await crearEntidad({
        type,
        text,
        date: date ? new Date(date) : null,
        time: time || null
      });
    } catch (e) {
      console.error('‚ùå [voice] Error creando:', e);
      alert('No se pudo crear: ' + (e?.message || e));
    }
  });

  // ---------- Realtime (opcional pero √∫til) ----------
  (async () => {
    const sb = getSB();
    if (!sb?.channel) return;

    let uid = null;
    try { uid = (await sb.auth.getUser())?.data?.user?.id || null; } catch {}

    const refresh = (type, payload) => {
      const row = payload.new || payload.old || {};
      refreshUIAfterChange(type, row);
    };

    const ch = sb.channel('rt-voice')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'notas',         filter: uid ? `owner_id=eq.${uid}` : undefined }, (p) => refresh('nota', p))
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks',         filter: uid ? `owner_id=eq.${uid}` : undefined }, (p) => refresh('tarea', p))
      .on('postgres_changes', { event: '*', schema: 'public', table: 'routines',      filter: uid ? `owner_id=eq.${uid}` : undefined }, (p) => refresh('rutina', p))
      .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments',  filter: uid ? `owner_id=eq.${uid}` : undefined }, (p) => refresh('cita', p))
            .on('postgres_changes', { event: '*', schema: 'public', table: 'lista_compra', filter: uid ? `owner_id=eq.${uid}` : undefined }, (p) => refresh('compra', p))

      .subscribe();

    window.addEventListener('beforeunload', () => { try { sb.removeChannel(ch); } catch {} });
  })();

})();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    window.verificarDespensaYActualizar?.();
  });
</script>
<script>
  // Recalcular lista de la compra cuando cambie stock o n¬∫ de personas
  window.addEventListener('despensa-cambiada', () => {
    window.verificarDespensaYActualizar?.();
  });
  window.addEventListener('personas-cambiadas', () => {
    window.verificarDespensaYActualizar?.();
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const qs = new URLSearchParams(location.search);
  const listenFlag = qs.get('listen') === '1' || location.hash.includes('listen');
  const isNative = !!(window.Capacitor?.isNativePlatform);

  if (listenFlag || isNative) {
    try { await window.startVoice?.(); } catch (e) {}
  }
});
</script>


<!-- Bot√≥n flotante -->
<button id="mini-mic" style="position:fixed;right:16px;bottom:16px;z-index:9999;
  width:56px;height:56px;border-radius:50%;border:none;background:#0ea5e9;color:white;">
  <i class="fa fa-microphone"></i>
</button>

<!-- Modal de voz -->
<div id="voice-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000;">
  <div style="background:#0f172a;color:#e5e7eb;padding:16px 18px;border-radius:12px;min-width:280px;max-width:90vw;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <strong>Voz</strong>
      <span style="font-size:12px;opacity:.8;">(habla y suelta)</span>
      <div style="flex:1"></div>
      <button id="voice-close" style="background:#334155;color:#fff;border:none;padding:6px 10px;border-radius:8px;">Cerrar</button>
    </div>
    <div id="voice-live" style="min-height:48px;padding:10px;background:#111827;border:1px solid #1f2937;border-radius:8px;">
      Escuchando‚Ä¶
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="voice-copy"   style="flex:1;background:#1f2937;color:#e5e7eb;border:none;padding:8px;border-radius:8px;">Copiar</button>
      <button id="voice-paste"  style="flex:1;background:#1f2937;color:#e5e7eb;border:none;padding:8px;border-radius:8px;">Pegar en la app</button>
      <button id="voice-create" style="flex:1;background:#10b981;color:#0b1324;border:none;padding:8px;border-radius:8px;">Crear seg√∫n comando</button>
    </div>
  </div>
</div>

<script>
  // helpers abrir/cerrar (los usa microfono.js)
  (function(){
    const modal = document.getElementById('voice-modal');
    window.openModal  = () => { modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); };
    window.closeModal = () => { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };
  })();
</script>

<!-- (si usas iframe para la app web) -->
<!-- <iframe id="app-frame" src="/" style="display:none"></iframe> -->

<!-- Carga del micro -->
<script src="/static/js/microfono.js"></script>

</body>
</html>
