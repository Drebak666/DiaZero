<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Mi Agenda</title>

<script>
  // Solo si no está ya establecido
  if (!localStorage.getItem("usuario_actual")) {
    localStorage.setItem("usuario_actual", localStorage.getItem("username"));
  }
</script>

<!-- Font Awesome para los iconos -->
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<!-- Enlace a tu hoja de estilos principal -->
<link href="/static/css/style.css" rel="stylesheet"/>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

</head>

<body>
<header style="margin-top:45px; text-align:center;">
  <span id="nombre-usuario" 
        style="display:inline-block; width:100%; max-width:600px; padding:10px; background:#0f172a; border:2px solid #00f5ff; border-radius:8px; color:white; font-weight:bold;">
    Usuario
  </span>
</header>



<main>
<section class="admin-card">
  <div class="section-content">
    <div id="ultimas-citas"><em>Cargando…</em></div>
  </div>
</section>





    <!-- Form edición tarea -->
    <div class="oculto form-modal" id="form-editar-tarea">
      <h3>Editar Tarea</h3>
      <form id="editar-formulario-tarea" class="form-editar-cita">
        <input id="editar-id-tarea" type="hidden" />
          <input id="editar-tipo" type="hidden" />

        <div class="form-group">
          <label for="editar-descripcion-tarea">Descripción:</label>
          <input id="editar-descripcion-tarea" type="text" placeholder="Descripción" />
        </div>
        <div class="form-grid-2cols">
          <div class="form-group">
            <label for="editar-fecha-tarea">Fecha:</label>
            <input id="editar-fecha-tarea" type="date" />
          </div>
         
        </div>
        <div class="form-grid-2cols">
          <div class="form-group">
            <label for="editar-hora-inicio-tarea">Hora de Inicio:</label>
            <input id="editar-hora-inicio-tarea" type="time" />
          </div>
          <div class="form-group">
            <label for="editar-hora-fin-tarea">Hora de Fin:</label>
            <input id="editar-hora-fin-tarea" type="time" />
          </div>
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn-success">Guardar Cambios</button>
          <button type="button" id="recoger-edicion-tarea" class="btn-cancel">Recoger</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Añadir Actividad -->
  <section class="main-section" id="añadir-actividad">
    <div class="section-content" id="form-nueva-actividad">
      <form id="nueva-actividad-formulario">
        <div class="activity-type-buttons">
          <button class="icon-button" data-type="Tarea" id="btn-tarea-actividad"><i class="fas fa-clipboard-list"></i></button>
          <button class="icon-button" data-type="Rutina" id="btn-rutina-actividad"><i class="fas fa-redo-alt"></i></button>
          <button class="icon-button" data-type="Cita" id="btn-cita-actividad"><i class="fas fa-calendar-alt"></i></button>

          <button class="icon-button nota-btn" id="btn-nota-actividad" type="button">
            <i class="fas fa-sticky-note" style="color:red;"></i>
            <span class="badge-nota" id="contador-notas">0</span>
          </button>

          <a class="icon-button lista-btn" id="btn-lista" href="/lista-compra" title="Lista de compra">
            <i class="fas fa-list"></i>
            <span class="badge-lista" id="contador-lista">0</span>
          </a>
        </div>

        <div class="activity-quick-input">
          <div class="form-group">
            <input id="nueva-actividad-descripcion" type="text" placeholder="Añadir una nueva tarea, rutina o cita..." />
          </div>
        </div>

        <div class="oculto" id="formularios-actividad">
          <!-- Tarea -->
          <div class="tipo-formulario oculto" id="form-tarea">
           <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="tarea">
    <option value="">— Ninguno —</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="tarea-fecha">Fecha:</label>
                <input id="tarea-fecha" name="tarea_fecha" type="date"/>
              </div>
          
              <div class="form-group">
                <label for="tarea-hora-inicio">Hora de Inicio:</label>
                <input id="tarea-hora-inicio" name="tarea_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="tarea-hora-fin">Hora de Fin:</label>
                <input id="tarea-hora-fin" name="tarea_hora_fin" type="time"/>
              </div>
            </div>
          </div>

          <!-- Rutina -->
          <div class="tipo-formulario oculto" id="form-rutina">
<div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="rutina">
    <option value="">— Ninguno —</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-fecha">Fecha:</label>
                <input id="rutina-fecha" name="rutina_fecha" type="date"/>
              </div>
              <div class="form-group">
                <label for="rutina-fecha-fin">Fecha Fin:</label>
                <input id="rutina-fecha-fin" name="rutina_fecha_fin" type="date"/>
              </div>
              
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-hora-inicio">Hora Inicio:</label>
                <input id="rutina-hora-inicio" name="rutina_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="rutina-hora-fin">Hora Fin:</label>
                <input id="rutina-hora-fin" name="rutina_hora_fin" type="time"/>
              </div>
            </div>
            <div class="form-group dias-checkboxes">
              <label>Días:</label>
              <div class="dias-semana-wrapper">
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Lunes"> L</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Martes"> M</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Miércoles"> X</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Jueves"> J</label>
                </div>
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Viernes"> V</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Sábado"> S</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Domingo"> D</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Cita -->
          <div class="tipo-formulario oculto" id="form-cita">
          <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="cita">
    <option value="">— Ninguno —</option>
  </select>
</div>

            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-hora-inicio">Hora de Inicio:</label>
                <input id="cita-hora-inicio" name="cita_hora_inicio" type="time" />
              </div>
              <div class="form-group">
                <label for="cita-hora-fin">Hora de Fin:</label>
                <input id="cita-hora-fin" name="cita_hora_fin" type="time" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-fecha">Fecha:</label>
                <input id="cita-fecha" name="cita_fecha" type="date" />
              </div>
              <div class="form-group">
                <label for="nuevo-requisito-cita">Añadir Requisito:</label>
                <input type="text" id="nuevo-requisito-cita" placeholder="Ej: DNI, Informe médico" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group centrado-boton">
                <button type="button" id="btn-añadir-requisito-cita" class="btn-secondary">Añadir requisito</button>
              </div>
              <div class="form-group">
                <details class="requisitos-accordion" id="cita-requisitos-accordion">
                  <summary>Requisitos</summary>
                  <div class="requirements-list" id="cita-requisitos-container"></div>
                </details>
              </div>
            </div>
          </div>




        <div class="form-buttons oculto" id="botones-actividad">
          <button class="btn-success btn-large" id="btn-guardar-actividad" type="submit">Guardar</button>
          <button class="btn-cancel" id="cancelar-nueva-actividad" type="button">Cancelar</button>
        </div>
      </form>
    </div>


<!-- Modal: Editar Cita (completo) -->
<div class="form-modal oculto" id="modal-editar-cita">
  <form id="form-editar-cita" class="form-editar-cita">
    <h3>Editar Cita</h3>
    <input type="hidden" id="edit-cita-id" />

    <div class="form-group">
      <label for="edit-cita-desc">Descripción:</label>
      <input id="edit-cita-desc" type="text" placeholder="Descripción de la cita" />
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-fecha">Fecha:</label>
        <input id="edit-cita-fecha" type="date" />
      </div>
      <div class="form-group">
        <label for="edit-cita-inicio">Hora de Inicio:</label>
        <input id="edit-cita-inicio" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-req-input">Añadir Requisito:</label>
        <input id="edit-cita-req-input" type="text" placeholder="Ej: DNI, Informe médico" />
      </div>
      <div class="form-group">
        <label for="edit-cita-fin">Hora de Fin:</label>
        <input id="edit-cita-fin" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols" style="align-items:flex-start;">
      <div class="form-group" style="grid-column:1 / span 1;">
        <div id="edit-cita-req-list" class="req-chip-box"></div>
      </div>
      <div class="form-group" style="display:flex; align-items:flex-start; justify-content:flex-end;">
        <button type="button" id="btn-add-req" class="btn-secondary" style="min-width:180px;">Añadir requisito</button>
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" class="btn-success">Guardar Cambios</button>
      <button type="button" id="cerrar-modal-cita" class="btn-cancel">Recoger</button>
    </div>
  </form>
</div>

<!-- Modal: Compartir -->
<div class="form-modal oculto" id="modal-compartir">
  <form id="form-compartir">
    <h3>Compartir</h3>
    <input type="hidden" id="share-id" />

    <div class="form-grid-2cols">
      <div class="form-group">
        <label>Grupo</label>
        <select id="share-grupo">
          <option value="">— Ninguno —</option>
        </select>
      </div>

      <div class="form-group">
        <label>Personas</label>
        <div id="share-personas" class="checklist"></div>
      </div>
    </div>

    <div class="form-buttons" style="gap:8px;">
      <button type="button" id="share-clear" class="btn-cancel">Quitar todo</button>
      <div style="flex:1"></div>
      <button type="button" id="share-cancel" class="btn-cancel">Cancelar</button>
      <button type="submit" class="btn-success">Guardar</button>
    </div>
  </form>
</div>

  </section>

  <!-- Agenda de Hoy -->
  <section class="main-section" id="agenda-de-hoy">
    <div class="section-content" id="agenda-container"></div>
  </section>

  <!-- Comida de Hoy (sin carrusel) -->
  <section class="main-section" id="comida-de-hoy">
    <div class="section-content" id="comida-container"></div>
  </section>

  <!-- Navegación (GRID 3 columnas, sin carrusel) -->
<section class="main-section" id="navegacion">
  <h2>NAVEGACIÓN</h2>
  <div class="section-content">
<div class="nav-grid" style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; justify-items:center;">
      <a class="icon-button" href="/reproductor"><i class="fas fa-music"></i><span>Audio</span></a>
      <a class="icon-button" href="/documentos"><i class="fas fa-file-alt"></i><span>Docs</span></a>
      <a class="icon-button" href="/registro"><i class="fas fa-clipboard-check"></i><span>Registro</span></a>
      <a class="icon-button" href="/calendario"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
      <a class="icon-button" href="/ejercicio"><i class="fas fa-dumbbell"></i><span>Ejercicio</span></a>

      <!-- ====== SCRIPTS ====== -->

<script type="module" src="/static/js/gestor-actividades.js"></script>
<script type="module" src="/static/js/admin-groups.js"></script>

 
       
     
       
     
     
     




      <!-- Botón de cerrar sesión abajo -->
      <button id="cerrar-sesion" class="icon-button" style="background-color:red; border:none; cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i><span>Cerrar sesión</span>
      </button>
      


    </div>
  </div>
</section>


  <!-- Acceso Administración -->
  <section class="main-section" id="admin-acceso">
    <a href="/admin" class="btn-admin-wide">
      <i class="fas fa-cog"></i>
      <span>Administración</span>
    </a>
  </section>

  
</main>

<footer></footer>

<!-- Scripts -->
 
<script src="{{ url_for('static', filename='js/supabaseClient.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/main.js') }}" type="module"></script>
<script type="module" src="{{ url_for('static', filename='js/ultimas-citas.js') }}"></script>
{% if cargar_add_activity %}
  <script src="{{ url_for('static', filename='js/add-activity.js') }}" type="module"></script>
{% endif %}
<script src="{{ url_for('static', filename='js/today-agenda.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/recetas.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/comida_dia.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/usuario.js') }}" type="module"></script>





<!-- Asegurar sesión + decidir si mostrar Admin -->
<script type="module">
  import { supabase } from "{{ url_for('static', filename='js/supabaseClient.js') }}";
  
  const ADMIN_SELECTORS = ['#admin-acceso', '#admin-btn'];
  const hideAdminUI = () => ADMIN_SELECTORS.forEach(sel => document.querySelector(sel)?.classList.add('oculto'));

  (async () => {
    const username = localStorage.getItem('usuario_actual');
    if (!username) return hideAdminUI();

    try {
      await fetch('/api/ensure-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username })
      });
    } catch (_) { /* no bloquear */ }

    const { data, error } = await supabase
      .from('usuarios')
      .select('role')
      .eq('username', username)
      .maybeSingle();

    if (error || !data || data.role !== 'admin') hideAdminUI();
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("usuario_actual");
  if (username) {
    document.getElementById("nombre-usuario").textContent = username;
  }
});
</script>
<script>
  if (!location.pathname.startsWith('/app')) {
    if (localStorage.getItem('modo_continuo') !== 'on') {
      localStorage.setItem('modo_continuo', 'on');
      const to = location.pathname + location.search + location.hash;
      location.replace('/app?to=' + encodeURIComponent(to));
    }
  }
</script>





<button id="quick-mic-btn" title="Capturar por voz">
  <i class="fas fa-microphone"></i>
</button>

<!-- Panel de resultado -->
<div id="quick-mic-panel" hidden>
  <div class="qmp-header">
    <strong>Captura rápida</strong>
    <button type="button" id="qmp-close" aria-label="Cerrar">×</button>
  </div>
  <div class="qmp-body">
    <label>Nombre</label>
    <input id="qmp-name" type="text" placeholder="Nombre" />
    <label>Teléfono</label>
    <input id="qmp-phone" type="text" inputmode="tel" placeholder="+34 600 123 456" />
    <div class="qmp-actions">
      <button id="qmp-save-note" class="primary">Guardar en Notas</button>
      <button id="qmp-copy">Copiar</button>
    </div>
    <div id="qmp-status" class="qmp-status"></div>
  </div>
</div>




</body>
</html>
