<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Mi Agenda</title>



<script>
(() => {
  const orig = window.fetch;
  window.fetch = async (input, init) => {
    let url = typeof input === 'string' ? input : (input && input.url) || '';

    if (url.includes('/rest/v1/')) {
      if (window.UID && /owner_id=eq\.[^&@]+@[^&]+/.test(url)) {
        url = url.replace(/owner_id=eq\.[^&]+/, `owner_id=eq.${window.UID}`);
      }

      if (url.includes('.is.null')) {
        // 🔎 LOG CON PILA para ver archivo y línea que hacen la petición
        console.warn('is.null detectado → origen abajo ↓\n', url);
        console.trace('stack');

        // (opcional) quitar el limit conflictivo si viene junto
        url = url.replace(/[?&]limit=1:1(?=&|$)/, (m) => (m.startsWith('?') ? '?' : ''));
      }
    }

    return orig(typeof input === 'string' ? url : new Request(url, input), init);
  };
})();
</script>







<script>
  // Solo si no está ya establecido
  if (!localStorage.getItem("usuario_actual")) {
    localStorage.setItem("usuario_actual", localStorage.getItem("username"));
  }
</script>

<!-- Font Awesome para los iconos -->
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<!-- Enlace a tu hoja de estilos principal -->
<link href="/static/css/style.css" rel="stylesheet"/>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

</head>

<body>
<header style="margin-top:45px; text-align:center;">
  <span id="nombre-usuario" 
        style="display:inline-block; width:100%; max-width:600px; padding:10px; background:#0f172a; border:2px solid #00f5ff; border-radius:8px; color:white; font-weight:bold;">
    Usuario
  </span>
</header>



<main>
<section class="admin-card">
  <div class="section-content">
    <div id="ultimas-citas"><em>Cargando…</em></div>
  </div>
</section>





    <!-- Form edición tarea -->
    <!-- Form edición tarea -->
<!-- Form edición tarea -->
<div class="oculto form-modal" id="form-editar-tarea">
  <h3>Editar Tarea</h3>
  <form id="editar-formulario-tarea" class="form-editar-cita">
    <input id="editar-id-tarea" type="hidden" />
    <input id="editar-tipo" type="hidden" />

    <div class="form-group">
      <label for="editar-descripcion-tarea">Descripción:</label>
      <input id="editar-descripcion-tarea" type="text" placeholder="Descripción" />
    </div>

    <!-- Fecha + Hora de inicio en una sola fila -->
    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="editar-fecha-tarea">Fecha:</label>
        <input id="editar-fecha-tarea" type="date" />
      </div>
      <div class="form-group">
        <label for="editar-hora-inicio-tarea">Hora de Inicio:</label>
        <input id="editar-hora-inicio-tarea" type="time" />
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" class="btn-success">Guardar Cambios</button>
      <button type="button" id="recoger-edicion-tarea" class="btn-cancel">Recoger</button>
    </div>
  </form>
</div>


  </section>

  <!-- Añadir Actividad -->
  <section class="main-section" id="añadir-actividad">
    <div class="section-content" id="form-nueva-actividad">
      <form id="nueva-actividad-formulario">
        <div class="activity-type-buttons">
          <button class="icon-button" data-type="Tarea" id="btn-tarea-actividad"><i class="fas fa-clipboard-list"></i></button>
          <button class="icon-button" data-type="Rutina" id="btn-rutina-actividad"><i class="fas fa-redo-alt"></i></button>
          <button class="icon-button" data-type="Cita" id="btn-cita-actividad"><i class="fas fa-calendar-alt"></i></button>

          <button class="icon-button nota-btn" id="btn-nota-actividad" type="button">
            <i class="fas fa-sticky-note" style="color:red;"></i>
            <span class="badge-nota" id="contador-notas">0</span>
          </button>

          <a class="icon-button lista-btn" id="btn-lista" href="/lista-compra" title="Lista de compra">
            <i class="fas fa-list"></i>
            <span class="badge-lista" id="contador-lista">0</span>
          </a>
        </div>

        <div class="activity-quick-input">
          <div class="form-group">
            <input id="nueva-actividad-descripcion" type="text" placeholder="Añadir una nueva tarea, rutina o cita..." />
          </div>
        </div>

        <div class="oculto" id="formularios-actividad">
          <!-- Tarea -->
          <div class="tipo-formulario oculto" id="form-tarea">
           <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="tarea">
    <option value="">— Ninguno —</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="tarea-fecha">Fecha:</label>
                <input id="tarea-fecha" name="tarea_fecha" type="date"/>
              </div>
          
              <div class="form-group">
                <label for="tarea-hora-inicio">Hora de Inicio:</label>
                <input id="tarea-hora-inicio" name="tarea_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="tarea-hora-fin">Hora de Fin:</label>
                <input id="tarea-hora-fin" name="tarea_hora_fin" type="time"/>
              </div>
            </div>
          </div>

          <!-- Rutina -->
          <div class="tipo-formulario oculto" id="form-rutina">
<div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="rutina">
    <option value="">— Ninguno —</option>
  </select>
</div>


            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-fecha">Fecha:</label>
                <input id="rutina-fecha" name="rutina_fecha" type="date"/>
              </div>
              <div class="form-group">
                <label for="rutina-fecha-fin">Fecha Fin:</label>
                <input id="rutina-fecha-fin" name="rutina_fecha_fin" type="date"/>
              </div>
              
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="rutina-hora-inicio">Hora Inicio:</label>
                <input id="rutina-hora-inicio" name="rutina_hora_inicio" type="time"/>
              </div>
              <div class="form-group">
                <label for="rutina-hora-fin">Hora Fin:</label>
                <input id="rutina-hora-fin" name="rutina_hora_fin" type="time"/>
              </div>
            </div>
            <div class="form-group dias-checkboxes">
              <label>Días:</label>
              <div class="dias-semana-wrapper">
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Lunes"> L</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Martes"> M</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Miércoles"> X</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Jueves"> J</label>
                </div>
                <div class="dias-fila">
                  <label><input type="checkbox" name="rutina_dia_semana" value="Viernes"> V</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Sábado"> S</label>
                  <label><input type="checkbox" name="rutina_dia_semana" value="Domingo"> D</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Cita -->
          <div class="tipo-formulario oculto" id="form-cita">
          <div class="form-group">
  <label>Asignar a grupo (opcional)</label>
  <select class="select-grupo" data-target="cita">
    <option value="">— Ninguno —</option>
  </select>
</div>

            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-hora-inicio">Hora de Inicio:</label>
                <input id="cita-hora-inicio" name="cita_hora_inicio" type="time" />
              </div>
              <div class="form-group">
                <label for="cita-hora-fin">Hora de Fin:</label>
                <input id="cita-hora-fin" name="cita_hora_fin" type="time" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group">
                <label for="cita-fecha">Fecha:</label>
                <input id="cita-fecha" name="cita_fecha" type="date" />
              </div>
              <div class="form-group">
                <label for="nuevo-requisito-cita">Añadir Requisito:</label>
                <input type="text" id="nuevo-requisito-cita" placeholder="Ej: DNI, Informe médico" />
              </div>
            </div>
            <div class="form-grid-2cols">
              <div class="form-group centrado-boton">
                <button type="button" id="btn-añadir-requisito-cita" class="btn-secondary">Añadir requisito</button>
              </div>
              <div class="form-group">
                <details class="requisitos-accordion" id="cita-requisitos-accordion">
                  <summary>Requisitos</summary>
                  <div class="requirements-list" id="cita-requisitos-container"></div>
                </details>
              </div>
            </div>
          </div>




        <div class="form-buttons oculto" id="botones-actividad">
          <button class="btn-success btn-large" id="btn-guardar-actividad" type="submit">Guardar</button>
          <button class="btn-cancel" id="cancelar-nueva-actividad" type="button">Cancelar</button>
        </div>
      </form>
    </div>


<!-- Modal: Editar Cita (completo) -->
<div class="form-modal oculto" id="modal-editar-cita">
  <form id="form-editar-cita" class="form-editar-cita">
    <h3>Editar Cita</h3>
    <input type="hidden" id="edit-cita-id" />

    <div class="form-group">
      <label for="edit-cita-desc">Descripción:</label>
      <input id="edit-cita-desc" type="text" placeholder="Descripción de la cita" />
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-fecha">Fecha:</label>
        <input id="edit-cita-fecha" type="date" />
      </div>
      <div class="form-group">
        <label for="edit-cita-inicio">Hora de Inicio:</label>
        <input id="edit-cita-inicio" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols">
      <div class="form-group">
        <label for="edit-cita-req-input">Añadir Requisito:</label>
        <input id="edit-cita-req-input" type="text" placeholder="Ej: DNI, Informe médico" />
      </div>
      <div class="form-group">
        <label for="edit-cita-fin">Hora de Fin:</label>
        <input id="edit-cita-fin" type="time" />
      </div>
    </div>

    <div class="form-grid-2cols" style="align-items:flex-start;">
      <div class="form-group" style="grid-column:1 / span 1;">
        <div id="edit-cita-req-list" class="req-chip-box"></div>
      </div>
      <div class="form-group" style="display:flex; align-items:flex-start; justify-content:flex-end;">
        <button type="button" id="btn-add-req" class="btn-secondary" style="min-width:180px;">Añadir requisito</button>
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" class="btn-success">Guardar Cambios</button>
      <button type="button" id="cerrar-modal-cita" class="btn-cancel">Recoger</button>
    </div>
  </form>
</div>

<!-- Modal: Compartir -->
<div class="form-modal oculto" id="modal-compartir">
  <form id="form-compartir">
    <h3>Compartir</h3>
    <input type="hidden" id="share-id" />

    <div class="form-grid-2cols">
      <div class="form-group">
        <label>Grupo</label>
        <select id="share-grupo">
          <option value="">— Ninguno —</option>
        </select>
      </div>

      <div class="form-group">
        <label>Personas</label>
        <div id="share-personas" class="checklist"></div>
      </div>
    </div>

    <div class="form-buttons" style="gap:8px;">
      <button type="button" id="share-clear" class="btn-cancel">Quitar todo</button>
      <div style="flex:1"></div>
      <button type="button" id="share-cancel" class="btn-cancel">Cancelar</button>
      <button type="submit" class="btn-success">Guardar</button>
    </div>
  </form>
</div>

  </section>

  <!-- Agenda de Hoy -->
  <section class="main-section" id="agenda-de-hoy">
    <div class="section-content" id="agenda-container"></div>
  </section>

  <!-- Comida de Hoy (sin carrusel) -->
  <section class="main-section" id="comida-de-hoy">
    <div class="section-content" id="comida-container"></div>
  </section>

  <!-- Navegación (GRID 3 columnas, sin carrusel) -->
<section class="main-section" id="navegacion">
  <h2>NAVEGACIÓN</h2>
  <div class="section-content">
<div class="nav-grid" style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; justify-items:center;">
      <a class="icon-button" href="/reproductor"><i class="fas fa-music"></i><span>Audio</span></a>
      <a class="icon-button" href="/documentos"><i class="fas fa-file-alt"></i><span>Docs</span></a>
      <a class="icon-button" href="/registro"><i class="fas fa-clipboard-check"></i><span>Registro</span></a>
      <a class="icon-button" href="/calendario"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
      <a class="icon-button" href="/ejercicio"><i class="fas fa-dumbbell"></i><span>Ejercicio</span></a>

      <!-- ====== SCRIPTS ====== -->

<script type="module" src="/static/js/gestor-actividades.js"></script>
<script type="module" src="/static/js/admin-groups.js"></script>

 
       
     
       
     
     
     




      <!-- Botón de cerrar sesión abajo -->
      <button id="cerrar-sesion" class="icon-button" style="background-color:red; border:none; cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i><span>Cerrar sesión</span>
      </button>
      


    </div>
  </div>
</section>


  <!-- Acceso Administración -->
  <section class="main-section" id="admin-acceso">
    <a href="/admin" class="btn-admin-wide">
      <i class="fas fa-cog"></i>
      <span>Administración</span>
    </a>
  </section>

  
</main>

<footer></footer>

<!-- Scripts -->
 
<script src="{{ url_for('static', filename='js/supabaseClient.js') }}" type="module"></script>


<script type="module">
  import { getUID } from "{{ url_for('static', filename='js/supabaseClient.js') }}";
  await getUID();            // deja window.UID listo para TODOS los fetch
</script>


<script src="{{ url_for('static', filename='js/main.js') }}" type="module"></script>
<script type="module" src="{{ url_for('static', filename='js/ultimas-citas.js') }}"></script>
{% if cargar_add_activity %}
  <script src="{{ url_for('static', filename='js/add-activity.js') }}" type="module"></script>
{% endif %}
<script src="{{ url_for('static', filename='js/today-agenda.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/recetas.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/comida_dia.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/usuario.js') }}" type="module"></script>





<!-- Asegurar sesión + decidir si mostrar Admin -->
<script type="module">
  import { supabase } from "{{ url_for('static', filename='js/supabaseClient.js') }}";
  
  const ADMIN_SELECTORS = ['#admin-acceso', '#admin-btn'];
  const hideAdminUI = () => ADMIN_SELECTORS.forEach(sel => document.querySelector(sel)?.classList.add('oculto'));

  (async () => {
    const username = localStorage.getItem('usuario_actual');
    if (!username) return hideAdminUI();

    try {
      await fetch('/api/ensure-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username })
      });
    } catch (_) { /* no bloquear */ }

    const { data, error } = await supabase
      .from('usuarios')
      .select('role')
      .eq('username', username)
      .maybeSingle();

    if (error || !data || data.role !== 'admin') hideAdminUI();
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("usuario_actual");
  if (username) {
    document.getElementById("nombre-usuario").textContent = username;
  }
});
</script>
<script>
  if (!location.pathname.startsWith('/app')) {
    if (localStorage.getItem('modo_continuo') !== 'on') {
      localStorage.setItem('modo_continuo', 'on');
      const to = location.pathname + location.search + location.hash;
      location.replace('/app?to=' + encodeURIComponent(to));
    }
  }
</script>







<script>

document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modal-compartir');
  if (!modal) return;

  const cancelBtn = document.getElementById('share-cancel');
  cancelBtn.addEventListener('click', () => {
    modal.classList.add('oculto');
  });
});

</script>

<!-- Flecha NAV (inline para saltar caché y subir z-index) -->
<!-- Flecha NAV (auto ↓/↑ con IntersectionObserver) -->
<style>
  .nav-shortcut{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(16px + env(safe-area-inset-bottom,0));
    z-index: 99999; /* por encima de todo (shell, mini-player, etc.) */
  }
  .nav-shortcut button{
    width: 46px; height: 46px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(17,24,39,.9); color:#e5e7eb;
    display:flex; align-items:center; justify-content:center;
    box-shadow: 0 6px 20px rgba(0,0,0,.35);
    backdrop-filter: blur(6px); cursor:pointer;
    transition: background .2s;
  }
  .nav-shortcut button:hover{ background: rgba(51,65,85,.95); }
</style>

<div class="nav-shortcut" aria-label="Ir a la navegación">
  <button id="nav-toggle-btn" title="Ir a Navegación">
    <i class="fa-solid fa-angles-down"></i>
  </button>
</div>

<script>
(() => {
  const btn = document.getElementById('nav-toggle-btn');
  const nav = document.getElementById('navegacion');
  if (!btn || !nav) return;

  const DOWN = '<i class="fa-solid fa-angles-down"></i>';
  const UP   = '<i class="fa-solid fa-angles-up"></i>';
  const smooth = { behavior: 'smooth', block: 'start' };
  const noMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  let atNav = false; // ¿navegación visible?

  // Observa si #navegacion entra/sale de la vista (40% visible = “estamos en navegación”)
  const io = new IntersectionObserver((entries) => {
    const e = entries[0];
    atNav = e.isIntersecting && e.intersectionRatio >= 0.4;
    btn.innerHTML = atNav ? UP : DOWN;
    btn.title     = atNav ? 'Volver arriba' : 'Ir a Navegación';
  }, { root: null, threshold: [0, .4, .6, 1] });

  io.observe(nav);

  // Click: baja si estás arriba; sube si ya estás en navegación
  btn.addEventListener('click', () => {
    if (atNav) {
      window.scrollTo({ top: 0, behavior: noMotion ? 'auto' : 'smooth' });
    } else {
      if (noMotion) nav.scrollIntoView(); else nav.scrollIntoView(smooth);
    }
  });

  // Ajuste inicial por si cargas ya cerca de navegación
  requestAnimationFrame(() => {
    // Forzamos primera evaluación
    const rect = nav.getBoundingClientRect();
    atNav = rect.top < window.innerHeight * 0.6;
    btn.innerHTML = atNav ? UP : DOWN;
    btn.title     = atNav ? 'Volver arriba' : 'Ir a Navegación';
  });
})();
</script>



</body>
</html>
