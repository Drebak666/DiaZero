<!doctype html>
<meta charset="utf-8">
<title>Dictado</title>
<style>
  html,body{height:100%;margin:0}
  body { font-family: system-ui, sans-serif; padding:24px; display:flex; flex-direction:column; gap:16px; }
  #live { flex:1; font-size:1.25rem; color:#111; border:1px solid #ddd; padding:12px; border-radius:8px; }
  #status { color:#444; font-size:.95rem; }
  #send {
    display:block; width:100%; padding:16px; font-size:1.15rem;
    border:0; border-radius:12px; color:#fff; background:#2563eb;
  }
  #stop {
    display:block; width:100%; padding:12px; font-size:1rem;
    border:0; border-radius:12px; color:#fff; background:#e11d48;
  }
</style>

<h2>Dicta tu nota</h2>
<div id="live" aria-live="polite">…</div>
<div id="status"></div>
<button id="send">ENVIAR A LA APP</button>
<button id="stop">DETENER</button>

<script>
const SR   = window.SpeechRecognition || window.webkitSpeechRecognition;
const qp   = new URLSearchParams(location.search);
const lang = qp.get('lang')   || 'es-ES';
const ret  = qp.get('return') || 'miagenda://dict';
const live = document.getElementById('live');
const stat = document.getElementById('status');
const btnOk= document.getElementById('send');
const btnSt= document.getElementById('stop');

let last = '';

function send(text){
  location.href = ret + '?text=' + encodeURIComponent(text || '');
}
function setStatus(s){ stat.textContent = s || ''; }

btnOk.addEventListener('click', () => send(last));
btnSt.addEventListener('click', () => {
  try { r && r.stop && r.stop(); } catch {}
  setStatus('Detenido. Puedes editar y pulsar ENVIAR.');
});

if (!SR) {
  setStatus('Este navegador no soporta dictado. Escribe y pulsa ENVIAR.');
} else {
  const r = new SR();
  r.lang = lang;
  r.interimResults = true;
  r.maxAlternatives = 1;
  r.continuous = false;

  r.onresult = (e) => {
    const i = e.results.length - 1;
    const frag = e.results[i]?.[0]?.transcript || '';
    if (frag) {
      last = (last ? last + ' ' : '') + frag;
      live.textContent = last;
      setStatus('Escuchando…');
    }
  };
  r.onerror = (e) => setStatus('Error: ' + (e?.error || e?.message || 'desconocido'));
  r.onend   = () => setStatus('Finalizado. Revisa y pulsa ENVIAR.');

  window.addEventListener('load', () => {
    try { r.start(); setStatus('Escuchando…'); } 
    catch { setStatus('No se pudo iniciar. Escribe y pulsa ENVIAR.'); }
  });
}
</script>
