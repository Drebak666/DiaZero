<!doctype html>
<meta charset="utf-8">
<title>Dictado</title>
<style>
  body { font-family: system-ui, sans-serif; padding:16px; }
  #live { font-size:1.25rem; color:#333; margin: 8px 0 16px; }
  button { padding:10px 14px; border:0; border-radius:8px; margin-right:8px; }
  #send { background:#2563eb; color:#fff; }
  #stop { background:#e11d48; color:#fff; }
  #status { color:#666; font-size:.9rem; }
</style>
<h3>Hablando…</h3>
<p id="live">…</p>
<p id="status"></p>
<p>
  <button id="send">Enviar</button>
  <button id="stop">Detener</button>
</p>

<script>
const SR    = window.SpeechRecognition || window.webkitSpeechRecognition;
const q     = new URLSearchParams(location.search);
const lang  = q.get('lang')   || 'es-ES';
const ret   = q.get('return') || 'miagenda://dict';
const live  = document.getElementById('live');
const stat  = document.getElementById('status');
const btnOk = document.getElementById('send');
const btnSt = document.getElementById('stop');

let last = '';
function send(text){
  location.href = ret + '?text=' + encodeURIComponent(text || '');
}

function setStatus(s){ stat.textContent = s || ''; }

// Auto-envío si hay silencio prolongado
let silenceTimer = null;
function armSilence(){
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(()=> {
    // Si ya hay algo dictado, enviamos automáticamente
    if (last && last.trim()) send(last);
  }, 2500); // 2.5 s de silencio
}

btnOk.addEventListener('click', () => send(last));
btnSt.addEventListener('click', () => {
  try { r && r.stop && r.stop(); } catch {}
  setStatus('Detenido. Pulsa “Enviar” para salir a la app.');
});

if (!SR) {
  setStatus('Este navegador no soporta dictado. Pulsa “Enviar” si ya hay texto.');
} else {
  const r = new SR();
  r.lang = lang;
  r.interimResults = true;
  r.maxAlternatives = 1;
  r.continuous = false; // cerrará tras una frase; si no, usamos silencio

  r.onresult = (e) => {
    const i = e.results.length - 1;
    last = (e.results[i] && e.results[i][0] && e.results[i][0].transcript) || last;
    live.textContent = last;
    setStatus('Escuchando…');
    armSilence();
  };
  r.onerror = () => {
    setStatus('Error en dictado. Puedes pulsar “Enviar”.');
  };
  r.onend = () => {
    // Si ya hay texto, envía; si no, deja que el usuario pulse “Enviar”
    if (last && last.trim()) send(last);
    else setStatus('Finalizado. Pulsa “Enviar” si hay texto.');
  };

  window.addEventListener('load', () => {
    try { r.start(); setStatus('Escuchando…'); } 
    catch { setStatus('No se pudo iniciar. Pulsa “Enviar”.'); }
  });
}
</script>
