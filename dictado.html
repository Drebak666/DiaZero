<!doctype html>
<meta charset="utf-8">
<title>Dictado</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:24px;display:flex;flex-direction:column;gap:16px}
  h2{margin:0 0 8px}
  #live{flex:1;font-size:1.15rem;color:#111;border:1px solid #ddd;border-radius:12px;padding:12px;min-height:140px}
  #status{color:#444;font-size:.95rem}
  .row{display:flex;gap:10px}
  button{flex:1;padding:14px 16px;font-size:1.05rem;border:0;border-radius:12px}
  #send{background:#2563eb;color:#fff}
  #stop{background:#e11d48;color:#fff}
</style>

<h2>Dicta tu nota</h2>
<div id="live" aria-live="polite">…</div>
<div id="status"></div>
<div class="row">
  <button id="send">ENVIAR A LA APP</button>
  <button id="stop">DETENER</button>
</div>

<script>
const SR   = window.SpeechRecognition || window.webkitSpeechRecognition;
const qs   = new URLSearchParams(location.search);
const lang = qs.get('lang')   || 'es-ES';
const ret  = qs.get('return') || 'miagenda://dict';
const live = document.getElementById('live');
const stat = document.getElementById('status');
const btnSend = document.getElementById('send');
const btnStop = document.getElementById('stop');

let textBuf = '';

function setStatus(s){ stat.textContent = s || ''; }

async function send(text){
  const t = (text || textBuf || '').trim();
  try {
    // 1) Pasa el texto al portapapeles del sistema (requiere gesto de usuario: el botón)
    await navigator.clipboard.writeText(t);
  } catch(e) {
    // si no pudiera, seguimos igual con deep-link; la app también acepta ?text=
  }
  // 2) Vuelve a la app indicando que use el portapapeles
  const url = t ? (ret + '?clip=1') : (ret);
  location.href = url;
}

btnSend.addEventListener('click', () => send(textBuf));
btnStop.addEventListener('click', () => { try { rec && rec.stop(); } catch{} setStatus('Detenido. Revisa y pulsa ENVIAR.'); });

let rec = null;
if (!SR) {
  setStatus('Este navegador no soporta dictado. Escribe aquí y pulsa ENVIAR.');
  live.contentEditable = 'true';
  live.addEventListener('input', ()=> { textBuf = live.textContent || ''; });
} else {
  rec = new SR();
  rec.lang = lang;
  rec.interimResults = true;
  rec.maxAlternatives = 1;
  rec.continuous = false; // una frase; luego puedes pulsar ENVIAR o dictar otra vez si recarga

  rec.onresult = (e) => {
    const i = e.results.length - 1;
    const frag = e.results[i]?.[0]?.transcript || '';
    if (frag) {
      textBuf = (textBuf ? textBuf + ' ' : '') + frag;
      live.textContent = textBuf;
      setStatus('Escuchando…');
    }
  };
  rec.onerror = (e) => setStatus('Error: ' + (e?.error || e?.message || 'desconocido'));
  rec.onend   = () => setStatus('Finalizado. Revisa y pulsa ENVIAR.');
  window.addEventListener('load', () => {
    try { rec.start(); setStatus('Escuchando…'); }
    catch { setStatus('No se pudo iniciar. Escribe y pulsa ENVIAR.'); }
  });
}
</script>
